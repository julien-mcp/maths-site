<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MCP — Générateur de devis (V2, intégré Excel)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --card:#111522;
      --muted:#8c93a7;
      --text:#e8ecf6;
      --accent:#7c5cff;
      --accent2:#20c997;
      --danger:#ff4d4d;
      --warn:#ffcc00;
      --line:#222a3d;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius:18px;
      --pad:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 12% 15%, rgba(124,92,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 88% 25%, rgba(32,201,151,.18), transparent 55%),
                  linear-gradient(180deg, #070910 0%, var(--bg) 100%);
      color:var(--text);
    }
    .wrap{
      max-width:1220px;
      margin:0 auto;
      padding:24px 16px 80px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr;}
    }
    header{
      grid-column: 1 / -1;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
    }
    .brand h1{margin:0;font-size:15px;letter-spacing:.4px}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .top-actions{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; align-items:center;}
    button, .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.2px;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      font-size:13px;
    }
    button:hover, .btn:hover{border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.10)}
    button:active{transform: translateY(1px)}
    .btn.primary{background: rgba(124,92,255,.18); border-color: rgba(124,92,255,.55)}
    .btn.good{background: rgba(32,201,151,.14); border-color: rgba(32,201,151,.5)}
    .btn.danger{background: rgba(255,77,77,.12); border-color: rgba(255,77,77,.45)}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent2)}
    .grid{display:grid; gap:14px;}
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.3px}
    .card .hd .sub{color:var(--muted);font-size:12px;margin-left:10px;font-weight:600}
    .card .bd{padding: 14px 16px 16px;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 680px){ .row{grid-template-columns: 1fr;} }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
      font-weight:650;
      letter-spacing:.2px;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 10px;
      border-radius: 14px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height: 70px; resize: vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
    }
    .hint{margin-top:6px;font-size:12px;color:rgba(140,147,167,.92);line-height:1.25}
    .hr{height:1px;background:var(--line); margin:14px 0}
    .badge{
      font-family: var(--mono);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(34,42,61,.8);
      vertical-align:top;
      font-size:13px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{border-bottom:none}
    .td-actions{white-space:nowrap; text-align:right}
    .mono{font-family:var(--mono)}
    .right{text-align:right}

    /* preview */
    .preview{position: sticky; top: 16px; align-self: start;}
    @media (max-width: 980px){ .preview{position: static;} }

    .doc{
      background: #fff;
      color:#111;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    .doc .page{padding: 22px 24px 24px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .doc .top{
      display:flex; justify-content:space-between; gap:14px; align-items:flex-start;
      border-bottom: 1px solid #eee;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .doc .top .mcp .name{font-weight:900; letter-spacing:.2px; font-size:16px;}
    .doc .top .mcp .meta{font-size:12px; color:#444; margin-top:6px; line-height:1.3; white-space:pre-wrap;}
    .doc .top .quote{text-align:right; min-width: 240px;}
    .doc .top .quote .title{font-weight:900; font-size:18px;}
    .doc .top .quote .ref{font-family: var(--mono); font-size:12px; color:#333; margin-top: 6px; line-height:1.3; white-space:pre-wrap;}
    .doc .blocks{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom: 12px;}
    .doc .box{border:1px solid #eee; border-radius: 14px; padding: 10px 12px; background:#fafafa;}
    .doc .box .t{font-weight:900; font-size:12px; color:#333; margin-bottom:6px;}
    .doc .box .c{font-size:12px; color:#333; line-height:1.35; white-space: pre-wrap;}
    .doc .items{width:100%; border-collapse:collapse; margin: 10px 0 12px; font-size:12px;}
    .doc .items th, .doc .items td{border-bottom:1px solid #eee; padding:8px 8px; font-size:12px;}
    .doc .items th{color:#555; background:#fafafa}
    .doc .items td.right{text-align:right}
    .doc .totals{margin-top: 10px; display:grid; grid-template-columns: 1fr 260px; gap:12px; align-items:start;}
    .doc .notes{font-size:11.5px; color:#333; line-height:1.35;}
    .doc .sum{border:1px solid #eee; border-radius: 14px; padding: 10px 12px; background:#fafafa;}
    .doc .sum .line{display:flex; justify-content:space-between; gap:10px; padding:4px 0; font-size:12px;}
    .doc .sum .line.total{font-weight:900; font-size:13px; border-top:1px solid #e9e9e9; margin-top:6px; padding-top:8px;}
    .doc .footer{
      border-top:1px solid #eee;
      margin-top:12px;
      padding-top:10px;
      font-size:11px;
      color:#444;
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }

    .checks{display:grid; gap:8px; margin-top:10px}
    .check{display:flex; gap:10px; align-items:flex-start; padding:10px 10px; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02)}
    .check input{width:auto; margin-top:2px}
    .check .t{font-weight:800; font-size:13px}
    .check .d{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.25}

    @media print{
      body{background:#fff}
      header, .card:not(.printable), .preview .card.hdtools{display:none !important}
      .wrap{max-width:none; padding:0; grid-template-columns: 1fr; gap:0}
      .preview{position:static}
      .doc{box-shadow:none; border:none; border-radius:0}
      .doc .page{padding:16mm}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>MCP — Générateur de devis (V2)</h1>
          <p>Inventaire + taux horaires importés · matériel dégressif · marge-cible · PDF via impression</p>
        </div>
      </div>
      <div class="top-actions">
        <span class="pill"><span class="dot"></span> Offline · autosave</span>
        <button class="btn small" id="btnNew">Nouveau</button>
        <button class="btn small" id="btnSave">Sauver</button>
        <button class="btn small" id="btnExport">Exporter JSON</button>
        <label class="btn small" for="importFile" style="cursor:pointer">Importer JSON</label>
        <input id="importFile" type="file" accept="application/json" hidden />
        <button class="btn small good" id="btnPrint">Imprimer / PDF</button>
      </div>
    </header>

    <div class="grid">
      <div class="card printable">
        <div class="hd">
          <div><h2>Paramètres globaux <span class="sub">TVA · marge · dégressivité</span></h2></div>
          <div class="pill"><span class="dot" id="dotMargin"></span><span id="kpiMargin" class="mono">—</span></div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Mode de chiffrage</label>
              <select id="pricingMode">
                <option value="sell">Mode vente (prix saisis)</option>
                <option value="target">Mode marge-cible (PU = coût/(1-marge))</option>
                <option value="hybrid" selected>Hybride (prix saisis + alerte)</option>
              </select>
              <div class="hint">
                En “marge-cible”, l’outil calcule automatiquement les PU à partir des coûts.
              </div>
            </div>
            <div>
              <label>Objectif résultat (marge sur CA)</label>
              <input id="targetMargin" type="number" min="0" max="0.95" step="0.01" value="0.50" />
              <div class="hint">0,50 = 50% (profit / CA HT).</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Taux de TVA</label>
              <select id="vatRate">
                <option value="0.20" selected>20% (standard)</option>
                <option value="0.10">10%</option>
                <option value="0.055">5,5%</option>
                <option value="0">0% (hors TVA / exonéré)</option>
              </select>
            </div>
            <div>
              <label>Dégressivité matériel</label>
              <select id="degressivityPreset">
                <option value="mcp" selected>1:100% · 2:70% · 3:60% · 4:55% · 5:50% · 6+:45%</option>
                <option value="soft">Douce (1:100 · 2:80 · 3:70 · 4+:65)</option>
                <option value="aggr">Agressive (1:100 · 2:65 · 3:55 · 4:50 · 5+:45)</option>
                <option value="custom">Personnalisée (texte)</option>
              </select>
            </div>
          </div>

          <div id="customDegWrap" style="display:none; margin-top:10px">
            <label>Barème personnalisé</label>
            <input id="customDeg" value='1:1,2:0.7,3:0.6,4:0.55,5:0.5,6+:0.45' />
            <div class="hint">Format : <span class="mono">jour:facteur</span> (ex: <span class="mono">6+</span>).</div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Référence devis</label>
              <input id="quoteRef" placeholder="DEV-2026-0001 (auto si vide)" />
            </div>
            <div>
              <label>Validité (jours)</label>
              <input id="validityDays" type="number" min="0" step="1" value="30" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Conditions de paiement</label>
              <input id="paymentTerms" value="40% à la commande, solde à la livraison (J+30)" />
            </div>
            <div>
              <label>Remise HT (€)</label>
              <input id="discount" type="number" step="1" value="0" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Notes (client)</label>
            <input id="publicNotes" value="Inclut 1 aller-retour de modifications. Toute demande supplémentaire fera l’objet d’un avenant." />
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Entreprise & client <span class="sub">document</span></h2>
          <span class="badge">Identité</span>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Nom entreprise</label>
              <input id="mcpName" value="Momentum Creative Productions (MCP)" />
            </div>
            <div>
              <label>Adresse / ville</label>
              <input id="mcpAddr" value="Lyon — France" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>SIRET (optionnel)</label>
              <input id="mcpSiret" placeholder="..." />
            </div>
            <div>
              <label>N° TVA (optionnel)</label>
              <input id="mcpVat" placeholder="FRxx..." />
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Client — entreprise</label>
              <input id="clientCompany" placeholder="Nom de l'entreprise" />
            </div>
            <div>
              <label>Client — contact</label>
              <input id="clientContact" placeholder="Nom + fonction" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Email</label>
              <input id="clientEmail" type="email" placeholder="contact@..." />
            </div>
            <div>
              <label>Téléphone</label>
              <input id="clientPhone" placeholder="+33 ..." />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Adresse</label>
              <textarea id="clientAddr" placeholder="Adresse complète (facturation)"></textarea>
            </div>
            <div>
              <label>SIRET / TVA (optionnel)</label>
              <textarea id="clientIds" placeholder="SIRET... / TVA..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Projet <span class="sub">brief</span></h2>
          <span class="badge">Brief</span>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Titre du projet</label>
              <input id="projectTitle" placeholder="Ex: Film corporate — site industriel" />
            </div>
            <div>
              <label>Lieu</label>
              <input id="projectPlace" placeholder="Ex: Lyon / site client" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Date(s)</label>
              <input id="projectDates" placeholder="Ex: 15–16 janvier 2026" />
            </div>
            <div>
              <label>Type</label>
              <select id="projectType">
                <option>Live TV / Webcast (interne ou externe)</option>
                <option>Film institutionnel / corporate (image)</option>
                <option>Film startup / investisseurs (pitch)</option>
                <option>Film marque employeur (recrutement)</option>
                <option>Aftermovie évènement</option>
                <option>Film communication interne / formation</option>
                <option>Autre</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Description</label>
            <textarea id="projectDesc" placeholder="Objectifs, livrables, diffusion, contraintes..."></textarea>
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Catalogue MCP <span class="sub">générer un pack (structure)</span></h2>
          <span class="badge">Packs</span>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Prestation (catalogue)</label>
              <select id="catalogType">
                <option value="Live TV / Webcast (interne ou externe)">Live TV / Webcast</option>
                <option value="Film institutionnel / corporate (image)">Film institutionnel / corporate</option>
                <option value="Film startup / investisseurs (pitch)">Film startup / investisseurs (pitch)</option>
                <option value="Film marque employeur (recrutement)">Film marque employeur</option>
                <option value="Aftermovie évènement">Aftermovie évènement</option>
                <option value="Film communication interne / formation">Com interne / formation</option>
              </select>
              <div class="hint">Basé sur ton catalogue. (Tu ajustes ensuite jours/PU.)</div>
            </div>
            <div>
              <label>Niveau</label>
              <select id="catalogPack">
                <option value="Essentiel">Essentiel</option>
                <option value="Standard" selected>Standard</option>
                <option value="Premium">Premium</option>
              </select>
              <div class="hint">Essentiel = 1 AR · Standard = 2 AR · Premium = 3+ AR.</div>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btnGeneratePack">Générer le pack (remplace lignes)</button>
            <button class="btn" id="btnAutoReprice">Auto-PU marge-cible</button>
          </div>

          <div class="hr"></div>

          <label>Options / add-ons (catalogue)</label>
          <div class="checks" id="addonsList"></div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="btnAddAddons">Ajouter options sélectionnées</button>
            <button class="btn danger" id="btnClearAddons">Tout décocher</button>
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Lignes — prestations <span class="sub">inclut rôles (heures)</span></h2>
          <div class="pill"><span class="dot"></span><span class="mono" id="countService">0</span>&nbsp;lignes</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Ajouter une ligne</label>
              <select id="serviceTemplate">
                <option value="custom">Ligne libre</option>
                <option value="prep">Pré-production (jour)</option>
                <option value="shoot">Tournage (jour)</option>
                <option value="live_prod">Production live (jour)</option>
                <option value="edit">Montage (jour)</option>
                <option value="color">Étalonnage (jour)</option>
                <option value="sound">Mixage (jour)</option>
                <option value="motion">Motion design (jour)</option>
                <option value="delivery">Exports / livraisons (forfait)</option>
              </select>
              <div class="hint">Les rôles (heures) sont ajoutés dynamiquement depuis ton calculateur.</div>
            </div>
            <div style="display:flex; align-items:end; gap:10px">
              <button class="btn primary" id="addService">+ Ajouter</button>
              <button class="btn danger" id="clearServices">Tout vider</button>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:220px">Désignation</th>
                  <th style="min-width:240px">Description</th>
                  <th class="right" style="width:90px">Qté</th>
                  <th style="width:90px">Unité</th>
                  <th class="right" style="width:140px">PU HT (€)</th>
                  <th class="right" style="width:150px">Coût unit. (€)</th>
                  <th class="right" style="width:140px">Total HT (€)</th>
                  <th class="right" style="width:150px">Coût total (€)</th>
                  <th class="td-actions" style="width:140px">Actions</th>
                </tr>
              </thead>
              <tbody id="tblServices"></tbody>
            </table>
          </div>

          <div class="hint" style="margin-top:10px">
            <b>Coût unit.</b> = coût par unité (ex: €/heure, €/jour). Le coût total est calculé automatiquement.
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Lignes — matériel <span class="sub">qté · jours · dégressivité</span></h2>
          <div class="pill"><span class="dot"></span><span class="mono" id="countGear">0</span>&nbsp;items</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Ajouter un item</label>
              <select id="gearItem"></select>
              <div class="hint">Préchargé depuis Inventaire matériel.xlsx (items avec tarif loc/jour).</div>
            </div>
            <div style="display:flex; align-items:end; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="addGear">+ Ajouter</button>
              <button class="btn" id="btnImportCSV">Importer inventaire CSV</button>
              <input id="csvArea" placeholder="Colle CSV: nom;tarif_jour;quantité (quantité optionnelle)" style="display:none" />
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:280px">Matériel</th>
                  <th class="right" style="width:90px">Qté</th>
                  <th class="right" style="width:90px">Jours</th>
                  <th class="right" style="width:140px">Tarif J1 (€)</th>
                  <th class="right" style="width:120px">Facteur</th>
                  <th class="right" style="width:140px">Total HT (€)</th>
                  <th class="td-actions" style="width:140px">Actions</th>
                </tr>
              </thead>
              <tbody id="tblGear"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Lignes — frais & divers <span class="sub">déplacements, sous-traitance…</span></h2>
          <div class="pill"><span class="dot"></span><span class="mono" id="countFees">0</span>&nbsp;lignes</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Ajouter une ligne</label>
              <select id="feeTemplate">
                <option value="custom">Ligne libre</option>
                <option value="travel">Déplacements</option>
                <option value="meals">Repas / catering</option>
                <option value="hotel">Hébergement</option>
                <option value="music">Droits musicaux / licences</option>
                <option value="st">Sous-traitance</option>
                <option value="misc">Divers</option>
              </select>
            </div>
            <div style="display:flex; align-items:end; gap:10px">
              <button class="btn primary" id="addFee">+ Ajouter</button>
              <button class="btn danger" id="clearFees">Tout vider</button>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:220px">Désignation</th>
                  <th style="min-width:240px">Description</th>
                  <th class="right" style="width:90px">Qté</th>
                  <th style="width:90px">Unité</th>
                  <th class="right" style="width:140px">PU HT (€)</th>
                  <th class="right" style="width:150px">Coût unit. (€)</th>
                  <th class="right" style="width:140px">Total HT (€)</th>
                  <th class="right" style="width:150px">Coût total (€)</th>
                  <th class="td-actions" style="width:140px">Actions</th>
                </tr>
              </thead>
              <tbody id="tblFees"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card printable">
        <div class="hd">
          <h2>Contrôle marge <span class="sub">HT</span></h2>
          <span class="badge">Analyse</span>
        </div>
        <div class="bd">
          <div class="row">
            <div class="pill" style="justify-content:space-between"><span>CA HT</span><span class="mono" id="kpiSales">—</span></div>
            <div class="pill" style="justify-content:space-between"><span>Coûts HT</span><span class="mono" id="kpiCosts">—</span></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="pill" style="justify-content:space-between"><span>Résultat</span><span class="mono" id="kpiProfit">—</span></div>
            <div class="pill" style="justify-content:space-between"><span>Marge sur CA</span><span class="mono" id="kpiProfitRate">—</span></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="pill" style="justify-content:space-between"><span>CA conseillé (cible)</span><span class="mono" id="kpiSuggestSales">—</span></div>
            <div class="pill" style="justify-content:space-between"><span>Total TTC</span><span class="mono" id="kpiTTC">—</span></div>
          </div>
          <div class="hint" style="margin-top:10px">
            NB : le “coût” ici vient de tes coûts unitaires (heures/jours/etc.). Le matériel est compté en CA (location), pas en coût d’amortissement.
          </div>
        </div>
      </div>
    </div>

    <div class="preview">
      <div class="card hdtools">
        <div class="hd">
          <h2>Aperçu <span class="sub">imprimable</span></h2>
          <span class="badge">Preview</span>
        </div>
        <div class="bd">
          <div class="pill" style="justify-content:space-between">
            <span>Total TTC</span><span class="mono" id="kpiTTC2">—</span>
          </div>
          <div class="hint" style="margin-top:10px">
            Clique <b>Imprimer / PDF</b> pour sortir un PDF propre.
          </div>
        </div>
      </div>

      <div class="doc" id="doc">
        <div class="page">
          <div class="top">
            <div class="mcp">
              <div class="name" id="docMcpName">Momentum Creative Productions (MCP)</div>
              <div class="meta" id="docMcpMeta">Lyon — France</div>
            </div>
            <div class="quote">
              <div class="title">DEVIS</div>
              <div class="ref" id="docRef">Réf. —</div>
              <div class="ref" id="docDate">Date —</div>
              <div class="ref" id="docValidity">Validité —</div>
            </div>
          </div>

          <div class="blocks">
            <div class="box">
              <div class="t">Client</div>
              <div class="c" id="docClient">—</div>
            </div>
            <div class="box">
              <div class="t">Projet</div>
              <div class="c" id="docProject">—</div>
            </div>
          </div>

          <table class="items">
            <thead>
              <tr>
                <th>Désignation</th>
                <th>Description</th>
                <th class="right">Qté</th>
                <th>Unité</th>
                <th class="right">PU HT</th>
                <th class="right">Total HT</th>
              </tr>
            </thead>
            <tbody id="docItems"></tbody>
          </table>

          <div class="totals">
            <div class="notes">
              <div><b>Conditions de paiement</b></div>
              <div id="docTerms">—</div>
              <div style="margin-top:8px"><b>Notes</b></div>
              <div id="docNotes">—</div>
              <div style="margin-top:8px"><small>TVA : <span id="docVatNote">—</span></small></div>
            </div>
            <div class="sum">
              <div class="line"><span>Total HT</span><span id="docHT">—</span></div>
              <div class="line"><span>Remise</span><span id="docDisc">—</span></div>
              <div class="line"><span>TVA</span><span id="docVAT">—</span></div>
              <div class="line total"><span>Total TTC</span><span id="docTTC">—</span></div>
            </div>
          </div>

          <div class="footer">
            <div id="docFooterLeft">Momentum Creative Productions — Devis</div>
            <div id="docFooterRight">Paiement : <span id="docPay">—</span></div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   MCP Devis — V2 (intégrée)
   ========================= */

const fmtEUR = (v) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(isFinite(v)? v : 0);
const fmtPct = (v) => (isFinite(v)? (v*100).toFixed(1) : '0.0') + ' %';
const todayStr = () => new Intl.DateTimeFormat('fr-FR', {year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date());
const clamp = (v,a,b)=>Math.min(Math.max(v,a),b);

let INVENTORY = [
  {
    "name": "Câbles — Câble HDMI 5m — Divers HDMI Premium",
    "dayRate": 5,
    "qtyAvail": 10,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Câble SDI 5m — Divers SDI 12G",
    "dayRate": 6,
    "qtyAvail": 30,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Câble XLR 10m — Divers XLR",
    "dayRate": 2.5,
    "qtyAvail": 30,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Câble XLR 20m — Divers XLR",
    "dayRate": 3,
    "qtyAvail": 5,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Câble XLR 5m — Divers XLR",
    "dayRate": 2,
    "qtyAvail": 5,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Touret combo — Divers 3G-SDI + RJ45 type 7 – 50m",
    "dayRate": 40,
    "qtyAvail": 10,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Touret HDMI — Divers HDMI fibre 50m",
    "dayRate": 17,
    "qtyAvail": 3,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Touret RJ45 50m — Divers RJ45",
    "dayRate": 10,
    "qtyAvail": 4,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Touret SDI 50m — Divers SDI",
    "dayRate": 15,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Câbles — Touret XLR 50m — Divers XLR",
    "dayRate": 15,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Câbles — XLR 2m — Divers XLR",
    "dayRate": 1,
    "qtyAvail": 30,
    "source": "Somegec"
  },
  {
    "name": "Divers — Gaffer — Divers Gaffer",
    "dayRate": 3,
    "qtyAvail": 20,
    "source": "Somegec"
  },
  {
    "name": "Divers — Multiprise — Divers Multiprise",
    "dayRate": 1,
    "qtyAvail": 30,
    "source": "Somegec"
  },
  {
    "name": "Divers — Piles — Divers AA, AAA",
    "dayRate": 2,
    "qtyAvail": 30,
    "source": "Somegec"
  },
  {
    "name": "Divers — Serre-câble — Divers Velcro",
    "dayRate": 0.5,
    "qtyAvail": 200,
    "source": "Somegec"
  },
  {
    "name": "Divers — Talkback — Divers Talkback",
    "dayRate": 25,
    "qtyAvail": 6,
    "source": "Somegec"
  },
  {
    "name": "Divers — Adaptateurs — Divers HDMI/SDI",
    "dayRate": 2,
    "qtyAvail": 20,
    "source": "Somegec"
  },
  {
    "name": "Divers — Support — Divers Support écran",
    "dayRate": 20,
    "qtyAvail": 6,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Micro Converter SDI to HDMI",
    "dayRate": 5,
    "qtyAvail": 10,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Teranex Mini SDI to HDMI 12G",
    "dayRate": 10,
    "qtyAvail": 4,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Teranex Mini HDMI to SDI 12G",
    "dayRate": 10,
    "qtyAvail": 4,
    "source": "Somegec"
  },
  {
    "name": "Régie — Moniteur — Blackmagic SmartView Duo 2",
    "dayRate": 20,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Routeur — Blackmagic Videohub 20x20 12G",
    "dayRate": 70,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Switcher — Blackmagic ATEM 1 M/E Constellation HD",
    "dayRate": 100,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Switcher — Blackmagic ATEM Television Studio HD8 ISO",
    "dayRate": 150,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Télécommande — Blackmagic ATEM 1 M/E Advanced Panel 10",
    "dayRate": 150,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Télécommande — Blackmagic ATEM Camera Control Panel",
    "dayRate": 50,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Enregistreur — Blackmagic HyperDeck Studio HD Plus",
    "dayRate": 50,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Mini Converter Optical Fiber 12G",
    "dayRate": 10,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Mini Converter SDI to Audio 4K",
    "dayRate": 5,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Mini Converter SDI to HDMI 6G",
    "dayRate": 5,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Mini Converter HDMI to SDI 6G",
    "dayRate": 5,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Régie — Convertisseur — Blackmagic Mini Converter UpDownCross HD",
    "dayRate": 10,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Multiview — Blackmagic Multiview 16",
    "dayRate": 60,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Station — Blackmagic Web Presenter 4K",
    "dayRate": 40,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Régie — Tally — Tally-MA Blackmagic",
    "dayRate": 15,
    "qtyAvail": 4,
    "source": "Somegec"
  },
  {
    "name": "Caméra — Caméra — Sony FX6",
    "dayRate": 160,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Caméra — Follow focus — Tilta Nucleus Nano II",
    "dayRate": 180,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Caméra — Gimbal — DJI Ronin RS4 Pro Combo",
    "dayRate": 54,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Caméra — Objectif — Sony FE 28-70mm F2 GM",
    "dayRate": 89,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Caméra — Trépied — Manfrotto Nitrotech 608 + twin leg carbon",
    "dayRate": 35,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Caméra — Objectif — Irix Irix Cine Directors Set Sony E Metric",
    "dayRate": 350,
    "qtyAvail": 1,
    "source": "Lyon"
  },
  {
    "name": "Audio — Micro — Sennheiser MKH 416",
    "dayRate": 25,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Audio — HF — Sennheiser EW-DP 835 Set",
    "dayRate": 25,
    "qtyAvail": 2,
    "source": "Somegec"
  },
  {
    "name": "Audio — Enregistreur — Zoom F6",
    "dayRate": 15,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Lumière — Panneau LED — Aputure Amaran 300c",
    "dayRate": 30,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Lumière — Panneau LED — Nanlite Forza 60B II",
    "dayRate": 20,
    "qtyAvail": 1,
    "source": "Somegec"
  },
  {
    "name": "Lumière — Pied — Manfrotto 1004BAC",
    "dayRate": 5,
    "qtyAvail": 3,
    "source": "Somegec"
  }
];

const ROLE_RATES = [
  { "section": "PRE-PRODUCTION", "role": "Recherche", "rate": 50.0 },
  { "section": "PRE-PRODUCTION", "role": "Script/Storyboard", "rate": 50.0 },
  { "section": "PRE-PRODUCTION", "role": "Organisation", "rate": 50.0 },
  { "section": "PRE-PRODUCTION", "role": "Ideation", "rate": 50.0 },
  { "section": "PRODUCTION", "role": "Réalisateur", "rate": 91.5 },
  { "section": "PRODUCTION", "role": "Chef opérateur", "rate": 82.8 },
  { "section": "PRODUCTION", "role": "Cadreur", "rate": 36.5 },
  { "section": "PRODUCTION", "role": "Chef électricien", "rate": 38.2 },
  { "section": "PRODUCTION", "role": "Technicien vidéo", "rate": 39.0 },
  { "section": "PRODUCTION", "role": "Ingénieur du son", "rate": 37.0 },
  { "section": "PRODUCTION", "role": "Assistant son", "rate": 35.1 },
  { "section": "PRODUCTION", "role": "Monteur vision (switcher)", "rate": 37.6 },
  { "section": "PRODUCTION", "role": "Maquillage", "rate": 40.0 },
  { "section": "POST - PRODUCTION", "role": "Chef monteur", "rate": 39.0 },
  { "section": "POST - PRODUCTION", "role": "Étalonneur", "rate": 37.2 },
  { "section": "POST - PRODUCTION", "role": "Monteur son", "rate": 36.5 },
  { "section": "POST - PRODUCTION", "role": "Assistant monteur", "rate": 35.3 },
  { "section": "POST - PRODUCTION", "role": "Graphiste habillages", "rate": 37.2 },
  { "section": "TALENT", "role": "Présentateur/Journaliste", "rate": 3000.0 }
];

const DEG_PRESETS = {
  mcp: [
    {day:1, factor:1.00},
    {day:2, factor:0.70},
    {day:3, factor:0.60},
    {day:4, factor:0.55},
    {day:5, factor:0.50},
    {day:6, factor:0.45, plus:true},
  ],
  soft: [
    {day:1, factor:1.00},
    {day:2, factor:0.80},
    {day:3, factor:0.70},
    {day:4, factor:0.65, plus:true},
  ],
  aggr: [
    {day:1, factor:1.00},
    {day:2, factor:0.65},
    {day:3, factor:0.55},
    {day:4, factor:0.50},
    {day:5, factor:0.45, plus:true},
  ]
};

function parseCustomDeg(str){
  const parts = (str||"").split(",").map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(const p of parts){
    const [dRaw,fRaw] = p.split(":").map(x=>x.trim());
    if(!dRaw || !fRaw) continue;
    const plus = dRaw.endsWith("+");
    const day = parseInt(dRaw.replace("+",""), 10);
    const factor = parseFloat((fRaw||"").replace(",","."));
    if(Number.isFinite(day) && Number.isFinite(factor)){
      out.push({day, factor, plus});
    }
  }
  out.sort((a,b)=>a.day-b.day);
  return out.length ? out : DEG_PRESETS.mcp;
}
function getDegCurve(){
  const preset = el.degressivityPreset.value;
  if(preset === "custom") return parseCustomDeg(el.customDeg.value);
  return DEG_PRESETS[preset] || DEG_PRESETS.mcp;
}
function degFactorForDay(dayIndex, curve){
  const exact = curve.find(x=>x.day===dayIndex && !x.plus);
  if(exact) return exact.factor;
  const plus = curve.filter(x=>x.plus && dayIndex>=x.day).sort((a,b)=>b.day-a.day)[0];
  if(plus) return plus.factor;
  const prev = curve.filter(x=>x.day<=dayIndex && !x.plus).sort((a,b)=>b.day-a.day)[0];
  return prev ? prev.factor : 1.0;
}
function degressiveTotalPerUnit(dayRate, days, curve){
  let total = 0;
  for(let d=1; d<=days; d++){
    total += dayRate * degFactorForDay(d, curve);
  }
  const avgFactor = days>0 ? (total / (dayRate * days)) : 1;
  return {totalPerUnit: total, avgFactor};
}

/* -------- Add-ons du catalogue -------- */
const ADDONS = [
  {id:"st_fr",   name:"Sous-titres FR (création + incrustation)", desc:"Accessibilité, visionnage sans son", unit:"forfait", qty:1},
  {id:"st_en",   name:"Traduction + sous-titres EN", desc:"Communication internationale / investisseurs", unit:"forfait", qty:1},
  {id:"vo_fr",   name:"Voix off (FR)", desc:"Narration corporate / formation", unit:"forfait", qty:1},
  {id:"vo_en",   name:"Voix off (EN)", desc:"International", unit:"forfait", qty:1},
  {id:"md_s",    name:"Motion design “simple”", desc:"Titres, lower thirds, chiffres", unit:"jour", qty:0.5},
  {id:"md_a",    name:"Motion design “avancé”", desc:"Data, 2D/3D légère", unit:"jour", qty:1},
  {id:"drone",   name:"Drone (pilote + autorisations)", desc:"Plans d’ensemble, sites, événement", unit:"forfait", qty:1},
  {id:"studio",  name:"Studio / plateau (location)", desc:"Interviews propres, fond neutre, live", unit:"jour", qty:1},
  {id:"telep",   name:"Téléprompteur", desc:"Discours dirigeants, messages précis", unit:"jour", qty:1},
  {id:"makeup",  name:"Maquillage / coiffure", desc:"Interviews, marque employeur", unit:"jour", qty:1},
  {id:"cam2",    name:"2e caméra / cadreur", desc:"Multi-angles, live, événement", unit:"jour", qty:1},
  {id:"rush",    name:"Livraison express (24–48h)", desc:"Aftermovie ou urgent corporate", unit:"forfait", qty:1}
];

const state = {
  meta: {
    pricingMode:"hybrid",
    targetMargin:0.50,
    vatRate:0.20,
    degressivityPreset:"mcp",
    customDeg:"1:1,2:0.7,3:0.6,4:0.55,5:0.5,6+:0.45",
    quoteRef:"",
    validityDays:30,
    paymentTerms:"40% à la commande, solde à la livraison (J+30)",
    discount:0,
    publicNotes:"Inclut 1 aller-retour de modifications. Toute demande supplémentaire fera l’objet d’un avenant."
  },
  mcp:{name:"Momentum Creative Productions (MCP)", addr:"Lyon — France", siret:"", vat:""},
  client:{company:"", contact:"", email:"", phone:"", addr:"", ids:""},
  project:{title:"", place:"", dates:"", type:"Film institutionnel / corporate (image)", desc:""},
  services:[],
  gear:[],
  fees:[]
};

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* ==============
   Pricing engine
   ============== */
function computeLine(line){
  const qty = +line.qty || 0;
  const costUnit = +line.costUnit || 0;
  const costTotal = costUnit * qty;

  const mode = el.pricingMode.value;
  const target = clamp(+el.targetMargin.value || 0, 0, 0.95);

  let unitPrice = (line.unitPrice === "" || line.unitPrice === null || typeof line.unitPrice === "undefined")
    ? NaN
    : (+line.unitPrice || 0);

  if(mode === "target"){
    unitPrice = costUnit / Math.max(1 - target, 0.05);
  }
  if(!Number.isFinite(unitPrice)) unitPrice = 0;

  const total = unitPrice * qty;
  return {qty, unitPrice, costUnit, costTotal, total};
}

/* ==========
   DOM refs
   ========== */
const el = {
  pricingMode: document.getElementById("pricingMode"),
  targetMargin: document.getElementById("targetMargin"),
  vatRate: document.getElementById("vatRate"),
  degressivityPreset: document.getElementById("degressivityPreset"),
  customDegWrap: document.getElementById("customDegWrap"),
  customDeg: document.getElementById("customDeg"),

  quoteRef: document.getElementById("quoteRef"),
  validityDays: document.getElementById("validityDays"),
  paymentTerms: document.getElementById("paymentTerms"),
  discount: document.getElementById("discount"),
  publicNotes: document.getElementById("publicNotes"),

  mcpName: document.getElementById("mcpName"),
  mcpAddr: document.getElementById("mcpAddr"),
  mcpSiret: document.getElementById("mcpSiret"),
  mcpVat: document.getElementById("mcpVat"),

  clientCompany: document.getElementById("clientCompany"),
  clientContact: document.getElementById("clientContact"),
  clientEmail: document.getElementById("clientEmail"),
  clientPhone: document.getElementById("clientPhone"),
  clientAddr: document.getElementById("clientAddr"),
  clientIds: document.getElementById("clientIds"),

  projectTitle: document.getElementById("projectTitle"),
  projectPlace: document.getElementById("projectPlace"),
  projectDates: document.getElementById("projectDates"),
  projectType: document.getElementById("projectType"),
  projectDesc: document.getElementById("projectDesc"),

  catalogType: document.getElementById("catalogType"),
  catalogPack: document.getElementById("catalogPack"),
  btnGeneratePack: document.getElementById("btnGeneratePack"),
  addonsList: document.getElementById("addonsList"),
  btnAddAddons: document.getElementById("btnAddAddons"),
  btnClearAddons: document.getElementById("btnClearAddons"),

  serviceTemplate: document.getElementById("serviceTemplate"),
  addService: document.getElementById("addService"),
  clearServices: document.getElementById("clearServices"),
  tblServices: document.getElementById("tblServices"),
  countService: document.getElementById("countService"),

  gearItem: document.getElementById("gearItem"),
  addGear: document.getElementById("addGear"),
  tblGear: document.getElementById("tblGear"),
  countGear: document.getElementById("countGear"),
  btnImportCSV: document.getElementById("btnImportCSV"),
  csvArea: document.getElementById("csvArea"),

  feeTemplate: document.getElementById("feeTemplate"),
  addFee: document.getElementById("addFee"),
  clearFees: document.getElementById("clearFees"),
  tblFees: document.getElementById("tblFees"),
  countFees: document.getElementById("countFees"),

  kpiSales: document.getElementById("kpiSales"),
  kpiCosts: document.getElementById("kpiCosts"),
  kpiProfit: document.getElementById("kpiProfit"),
  kpiProfitRate: document.getElementById("kpiProfitRate"),
  kpiSuggestSales: document.getElementById("kpiSuggestSales"),
  kpiTTC: document.getElementById("kpiTTC"),
  kpiTTC2: document.getElementById("kpiTTC2"),
  kpiMargin: document.getElementById("kpiMargin"),
  dotMargin: document.getElementById("dotMargin"),

  btnAutoReprice: document.getElementById("btnAutoReprice"),

  btnNew: document.getElementById("btnNew"),
  btnSave: document.getElementById("btnSave"),
  btnExport: document.getElementById("btnExport"),
  importFile: document.getElementById("importFile"),
  btnPrint: document.getElementById("btnPrint"),

  docMcpName: document.getElementById("docMcpName"),
  docMcpMeta: document.getElementById("docMcpMeta"),
  docRef: document.getElementById("docRef"),
  docDate: document.getElementById("docDate"),
  docValidity: document.getElementById("docValidity"),
  docClient: document.getElementById("docClient"),
  docProject: document.getElementById("docProject"),
  docItems: document.getElementById("docItems"),
  docHT: document.getElementById("docHT"),
  docDisc: document.getElementById("docDisc"),
  docVAT: document.getElementById("docVAT"),
  docTTC: document.getElementById("docTTC"),
  docTerms: document.getElementById("docTerms"),
  docNotes: document.getElementById("docNotes"),
  docVatNote: document.getElementById("docVatNote"),
  docFooterLeft: document.getElementById("docFooterLeft"),
  docPay: document.getElementById("docPay"),
};

/* ==========
   Sync state
   ========== */
function syncStateFromInputs(){
  state.meta.pricingMode = el.pricingMode.value;
  state.meta.targetMargin = +el.targetMargin.value || 0;
  state.meta.vatRate = +el.vatRate.value || 0;
  state.meta.degressivityPreset = el.degressivityPreset.value;
  state.meta.customDeg = el.customDeg.value;
  state.meta.quoteRef = el.quoteRef.value.trim();
  state.meta.validityDays = +el.validityDays.value || 0;
  state.meta.paymentTerms = el.paymentTerms.value;
  state.meta.discount = +el.discount.value || 0;
  state.meta.publicNotes = el.publicNotes.value;

  state.mcp.name = el.mcpName.value;
  state.mcp.addr = el.mcpAddr.value;
  state.mcp.siret = el.mcpSiret.value;
  state.mcp.vat = el.mcpVat.value;

  state.client.company = el.clientCompany.value;
  state.client.contact = el.clientContact.value;
  state.client.email = el.clientEmail.value;
  state.client.phone = el.clientPhone.value;
  state.client.addr = el.clientAddr.value;
  state.client.ids = el.clientIds.value;

  state.project.title = el.projectTitle.value;
  state.project.place = el.projectPlace.value;
  state.project.dates = el.projectDates.value;
  state.project.type = el.projectType.value;
  state.project.desc = el.projectDesc.value;
}
function syncInputsFromState(){
  el.pricingMode.value = state.meta.pricingMode;
  el.targetMargin.value = state.meta.targetMargin;
  el.vatRate.value = state.meta.vatRate;
  el.degressivityPreset.value = state.meta.degressivityPreset;
  el.customDeg.value = state.meta.customDeg;
  el.quoteRef.value = state.meta.quoteRef;
  el.validityDays.value = state.meta.validityDays;
  el.paymentTerms.value = state.meta.paymentTerms;
  el.discount.value = state.meta.discount;
  el.publicNotes.value = state.meta.publicNotes;

  el.mcpName.value = state.mcp.name;
  el.mcpAddr.value = state.mcp.addr;
  el.mcpSiret.value = state.mcp.siret;
  el.mcpVat.value = state.mcp.vat;

  el.clientCompany.value = state.client.company;
  el.clientContact.value = state.client.contact;
  el.clientEmail.value = state.client.email;
  el.clientPhone.value = state.client.phone;
  el.clientAddr.value = state.client.addr;
  el.clientIds.value = state.client.ids;

  el.projectTitle.value = state.project.title;
  el.projectPlace.value = state.project.place;
  el.projectDates.value = state.project.dates;
  el.projectType.value = state.project.type;
  el.projectDesc.value = state.project.desc;
}

/* ==========
   UI helpers
   ========== */
function buildEditableCell(value, onChange, type="text", attrs={}){
  const input = document.createElement("input");
  input.type = type;
  input.value = value ?? "";
  for(const k in attrs) input.setAttribute(k, attrs[k]);
  input.addEventListener("input", ()=>onChange(input.value));
  return input;
}
function removeById(arr, id){
  const i = arr.findIndex(x=>x.id===id);
  if(i>=0) arr.splice(i,1);
}

/* ==========
   Templates
   ========== */
function addServiceLine(key){
  const templates = {
    custom: {name:"Prestation", desc:"", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    prep:   {name:"Pré-production", desc:"Cadrage, conducteur / script, repérage", unit:"jour", qty:1, unitPrice:"", costUnit:0},
    shoot:  {name:"Tournage", desc:"Captation sur site", unit:"jour", qty:1, unitPrice:"", costUnit:0},
    live_prod:{name:"Production live", desc:"Réalisation live + régie", unit:"jour", qty:1, unitPrice:"", costUnit:0},
    edit:   {name:"Montage", desc:"Montage + exports", unit:"jour", qty:1, unitPrice:"", costUnit:0},
    color:  {name:"Étalonnage", desc:"Correction colorimétrique", unit:"jour", qty:0.5, unitPrice:"", costUnit:0},
    sound:  {name:"Mixage", desc:"Nettoyage voix / équilibrage / mastering", unit:"jour", qty:0.5, unitPrice:"", costUnit:0},
    motion: {name:"Motion design", desc:"Habillage, titres, chiffres", unit:"jour", qty:0.5, unitPrice:"", costUnit:0},
    delivery:{name:"Livraisons", desc:"Exports, versions, livraison finale", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
  };

  if(key.startsWith("role:")){
    const idx = parseInt(key.split(":")[1], 10);
    const r = ROLE_RATES[idx];
    if(!r) return;
    state.services.push({
      id:uid(),
      name:`Rôle (heures) — ${r.role}`,
      desc:`Section: ${r.section} · Taux horaire (coût): ${r.rate} €/h`,
      unit:"heure",
      qty:8,
      unitPrice:"",
      costUnit:r.rate
    });
    return;
  }

  const t = templates[key] || templates.custom;
  state.services.push({id:uid(), ...t});
}

function addFeeLine(key){
  const templates = {
    custom:{name:"Frais", desc:"", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    travel:{name:"Déplacements", desc:"km, péages, train, parking", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    meals:{name:"Repas / catering", desc:"Repas équipe / plateau", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    hotel:{name:"Hébergement", desc:"Hôtel / logement", unit:"nuit", qty:1, unitPrice:"", costUnit:0},
    music:{name:"Droits musicaux", desc:"Licences, banques sonores, diffusion", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    st:{name:"Sous-traitance", desc:"Prestataire externe", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
    misc:{name:"Divers", desc:"", unit:"forfait", qty:1, unitPrice:"", costUnit:0},
  };
  const t = templates[key] || templates.custom;
  state.fees.push({id:uid(), ...t});
}

function addGearLine(invIndex){
  const it = INVENTORY[invIndex];
  if(!it) return;
  state.gear.push({id:uid(), name:it.name, dayRate:it.dayRate, qty:1, days:1, source:it.source});
}

/* ==========
   Render tables
   ========== */
function renderLinesTable(tbody, lines, kind){
  tbody.innerHTML = "";
  lines.forEach(line=>{
    const tr = document.createElement("tr");

    const c1 = document.createElement("td");
    c1.appendChild(buildEditableCell(line.name, v=>{line.name=v; refresh();}));
    tr.appendChild(c1);

    const c2 = document.createElement("td");
    const ta = document.createElement("textarea");
    ta.value = line.desc ?? "";
    ta.style.minHeight="44px";
    ta.addEventListener("input", ()=>{line.desc=ta.value; refresh();});
    c2.appendChild(ta);
    tr.appendChild(c2);

    const c3 = document.createElement("td"); c3.className="right";
    const qty = buildEditableCell(line.qty, v=>{line.qty=+v||0; refresh();}, "number", {step:"0.25", min:"0"});
    qty.style.textAlign="right"; c3.appendChild(qty);
    tr.appendChild(c3);

    const c4 = document.createElement("td");
    const unitSel = document.createElement("select");
    ["forfait","jour","heure","nuit","km","unité"].forEach(u=>{
      const o=document.createElement("option"); o.value=u; o.textContent=u; unitSel.appendChild(o);
    });
    unitSel.value = line.unit || "forfait";
    unitSel.addEventListener("change", ()=>{line.unit=unitSel.value; refresh();});
    c4.appendChild(unitSel);
    tr.appendChild(c4);

    const c5 = document.createElement("td"); c5.className="right";
    const pu = buildEditableCell(line.unitPrice ?? "", v=>{ line.unitPrice = v==="" ? "" : (+v||0); refresh(); }, "number", {step:"1", min:"0"});
    pu.style.textAlign="right"; c5.appendChild(pu);
    tr.appendChild(c5);

    const c6 = document.createElement("td"); c6.className="right";
    const cu = buildEditableCell(line.costUnit ?? 0, v=>{ line.costUnit = (+v||0); refresh(); }, "number", {step:"0.1", min:"0"});
    cu.style.textAlign="right"; c6.appendChild(cu);
    tr.appendChild(c6);

    const computed = computeLine(line);

    const c7 = document.createElement("td"); c7.className="right mono"; c7.textContent = fmtEUR(computed.total);
    tr.appendChild(c7);

    const c8 = document.createElement("td"); c8.className="right mono"; c8.textContent = fmtEUR(computed.costTotal);
    tr.appendChild(c8);

    const c9 = document.createElement("td"); c9.className="td-actions";
    const b1 = document.createElement("button");
    b1.className="btn small danger"; b1.textContent="Supprimer";
    b1.addEventListener("click", ()=>{
      if(kind==="services") removeById(state.services, line.id);
      if(kind==="fees") removeById(state.fees, line.id);
      refresh();
    });
    c9.appendChild(b1);
    tr.appendChild(c9);

    tbody.appendChild(tr);
  });
}

function renderGearTable(){
  el.tblGear.innerHTML = "";
  const curve = getDegCurve();

  state.gear.forEach(line=>{
    const tr = document.createElement("tr");

    const c1 = document.createElement("td");
    c1.appendChild(buildEditableCell(line.name, v=>{line.name=v; refresh();}));
    tr.appendChild(c1);

    const c2 = document.createElement("td"); c2.className="right";
    const q = buildEditableCell(line.qty, v=>{line.qty=+v||0; refresh();}, "number", {step:"1", min:"0"});
    q.style.textAlign="right"; c2.appendChild(q);
    tr.appendChild(c2);

    const c3 = document.createElement("td"); c3.className="right";
    const d = buildEditableCell(line.days, v=>{line.days=+v||0; refresh();}, "number", {step:"1", min:"0"});
    d.style.textAlign="right"; c3.appendChild(d);
    tr.appendChild(c3);

    const c4 = document.createElement("td"); c4.className="right";
    const dr = buildEditableCell(line.dayRate, v=>{line.dayRate=+v||0; refresh();}, "number", {step:"1", min:"0"});
    dr.style.textAlign="right"; c4.appendChild(dr);
    tr.appendChild(c4);

    const calc = degressiveTotalPerUnit(+line.dayRate||0, +line.days||0, curve);
    const total = (calc.totalPerUnit||0) * (+line.qty||0);

    const c5 = document.createElement("td"); c5.className="right mono";
    c5.textContent = (isFinite(calc.avgFactor)? calc.avgFactor.toFixed(2) : "—");
    tr.appendChild(c5);

    const c6 = document.createElement("td"); c6.className="right mono";
    c6.textContent = fmtEUR(total);
    tr.appendChild(c6);

    const c7 = document.createElement("td"); c7.className="td-actions";
    const b1 = document.createElement("button");
    b1.className="btn small danger"; b1.textContent="Supprimer";
    b1.addEventListener("click", ()=>{ removeById(state.gear, line.id); refresh(); });
    c7.appendChild(b1);
    tr.appendChild(c7);

    el.tblGear.appendChild(tr);
  });
}

/* ==========
   Totals / KPIs
   ========== */
function totals(){
  let sales = 0;
  let costs = 0;

  state.services.forEach(l=>{
    const c = computeLine(l);
    sales += c.total;
    costs += c.costTotal;
  });

  const curve = getDegCurve();
  state.gear.forEach(g=>{
    const calc = degressiveTotalPerUnit(+g.dayRate||0, +g.days||0, curve);
    sales += (calc.totalPerUnit||0) * (+g.qty||0);
  });

  state.fees.forEach(l=>{
    const c = computeLine(l);
    sales += c.total;
    costs += c.costTotal;
  });

  const discount = Math.max(+el.discount.value || 0, 0);
  sales -= discount;

  const profit = sales - costs;
  const profitRate = sales>0 ? profit/sales : 0;

  const target = clamp(+el.targetMargin.value||0, 0, 0.95);
  const suggestedSales = costs / Math.max(1 - target, 0.05);

  const vat = Math.max(sales, 0) * (+el.vatRate.value || 0);
  const ttc = Math.max(sales, 0) + vat;

  return {sales, costs, profit, profitRate, suggestedSales, vat, ttc, discount};
}

function ensureQuoteRef(){
  if(state.meta.quoteRef && state.meta.quoteRef.trim()) return state.meta.quoteRef.trim();
  const now = new Date();
  const y = now.getFullYear();
  const key = "mcp_quote_seq_" + y;
  const seq = +(localStorage.getItem(key) || "0") + 1;
  localStorage.setItem(key, String(seq));
  const ref = `DEV-${y}-${String(seq).padStart(4,"0")}`;
  state.meta.quoteRef = ref;
  el.quoteRef.value = ref;
  return ref;
}

/* ==========
   Document render
   ========== */
function renderDoc(){
  const t = totals();
  const ref = state.meta.quoteRef?.trim() ? state.meta.quoteRef.trim() : "—";
  el.docRef.textContent = `Réf. ${ref}`;
  el.docDate.textContent = `Date ${todayStr()}`;
  el.docValidity.textContent = `Validité ${state.meta.validityDays>0 ? state.meta.validityDays+" jours" : "—"}`;

  let mcpMeta = (state.mcp.addr||"").trim();
  const extras = [];
  if(state.mcp.siret?.trim()) extras.push(`SIRET: ${state.mcp.siret.trim()}`);
  if(state.mcp.vat?.trim()) extras.push(`TVA: ${state.mcp.vat.trim()}`);
  if(extras.length) mcpMeta += (mcpMeta? "\n":"") + extras.join(" · ");

  el.docMcpName.textContent = state.mcp.name || "Momentum Creative Productions (MCP)";
  el.docMcpMeta.textContent = mcpMeta || "—";

  const clientLines = [];
  clientLines.push((state.client.company||"—").trim());
  if(state.client.contact?.trim()) clientLines.push(state.client.contact.trim());
  const comm = [];
  if(state.client.email?.trim()) comm.push(state.client.email.trim());
  if(state.client.phone?.trim()) comm.push(state.client.phone.trim());
  if(comm.length) clientLines.push(comm.join(" · "));
  if(state.client.addr?.trim()) clientLines.push(state.client.addr.trim());
  if(state.client.ids?.trim()) clientLines.push(state.client.ids.trim());
  el.docClient.textContent = clientLines.filter(Boolean).join("\n") || "—";

  const projLines = [];
  projLines.push((state.project.title||"—").trim());
  const meta = [];
  if(state.project.type?.trim()) meta.push(state.project.type.trim());
  if(state.project.place?.trim()) meta.push(state.project.place.trim());
  if(state.project.dates?.trim()) meta.push(state.project.dates.trim());
  if(meta.length) projLines.push(meta.join(" · "));
  if(state.project.desc?.trim()) projLines.push(state.project.desc.trim());
  el.docProject.textContent = projLines.filter(Boolean).join("\n") || "—";

  el.docItems.innerHTML = "";

  const rows = [];

  state.services.forEach(l=>{
    const c = computeLine(l);
    rows.push({name:l.name, desc:l.desc, qty:c.qty, unit:l.unit, pu:c.unitPrice, total:c.total});
  });

  const curve = getDegCurve();
  state.gear.forEach(g=>{
    const calc = degressiveTotalPerUnit(+g.dayRate||0, +g.days||0, curve);
    const total = (calc.totalPerUnit||0) * (+g.qty||0);
    rows.push({
      name:`Location matériel — ${g.name}`,
      desc:`Source: ${g.source || ""} · Tarif J1: ${fmtEUR(+g.dayRate||0)} · Dégressivité appliquée`,
      qty:+g.qty||0,
      unit:"qté",
      pu: calc.totalPerUnit||0,
      total
    });
  });

  state.fees.forEach(l=>{
    const c = computeLine(l);
    rows.push({name:l.name, desc:l.desc, qty:c.qty, unit:l.unit, pu:c.unitPrice, total:c.total});
  });

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${(r.name||"")}</td>
      <td>${(r.desc||"")}</td>
      <td class="right">${(r.qty ?? 0)}</td>
      <td>${(r.unit||"")}</td>
      <td class="right">${fmtEUR(r.pu ?? 0)}</td>
      <td class="right">${fmtEUR(r.total ?? 0)}</td>
    `;
    el.docItems.appendChild(tr);
  });

  el.docHT.textContent = fmtEUR(t.sales);
  el.docDisc.textContent = t.discount>0 ? "− "+fmtEUR(t.discount) : fmtEUR(0);
  el.docVAT.textContent = fmtEUR(t.vat);
  el.docTTC.textContent = fmtEUR(t.ttc);

  el.docTerms.textContent = state.meta.paymentTerms || "—";
  el.docPay.textContent = state.meta.paymentTerms || "—";
  el.docNotes.textContent = state.meta.publicNotes || "—";

  const vatRate = +el.vatRate.value || 0;
  el.docVatNote.textContent = vatRate>0 ? `TVA au taux de ${(vatRate*100).toFixed(1).replace(".0","")}%.` : "TVA non applicable.";
  el.docFooterLeft.textContent = `${state.mcp.name || "Momentum Creative Productions"} — Devis ${ref}`;
}

/* ==========
   Packs generator
   ========== */
function setNotesForPack(pack){
  if(pack==="Essentiel"){
    el.publicNotes.value = "Pack Essentiel — 1 master + exports web · 1 aller-retour inclus. Toute demande supplémentaire fera l’objet d’un avenant.";
  } else if(pack==="Standard"){
    el.publicNotes.value = "Pack Standard — 1 master + 2–4 cutdowns + formats réseaux · 2 aller-retours inclus. Toute demande supplémentaire fera l’objet d’un avenant.";
  } else {
    el.publicNotes.value = "Pack Premium — master + déclinaisons multi-formats + kit social (assets) · 3+ aller-retours, suivi projet. Toute demande supplémentaire fera l’objet d’un avenant.";
  }
}
function generatePack(type, pack){
  // wipe
  state.services = [];
  state.gear = [];
  state.fees = [];

  // update project type
  el.projectType.value = type;

  // default “structure” (jours) à ajuster ensuite
  const days = (pack==="Essentiel") ? {pre:0.75, prod:1, post:1.25, md:0.25} :
               (pack==="Standard")  ? {pre:1.25, prod:1.5, post:2.5,  md:0.75} :
                                      {pre:2.5,  prod:3,   post:5,    md:2};

  addServiceLine("prep");  state.services[state.services.length-1].qty = days.pre;

  if(type.startsWith("Live TV")){
    addServiceLine("live_prod"); state.services[state.services.length-1].qty = Math.max(1, Math.round(days.prod));
    addServiceLine("delivery");  state.services[state.services.length-1].qty = 1;
  } else {
    addServiceLine("shoot"); state.services[state.services.length-1].qty = days.prod;
    addServiceLine("edit");  state.services[state.services.length-1].qty = days.post;
    addServiceLine("color"); state.services[state.services.length-1].qty = (pack==="Essentiel") ? 0.25 : (pack==="Standard") ? 0.5 : 1;
    addServiceLine("sound"); state.services[state.services.length-1].qty = (pack==="Essentiel") ? 0.25 : (pack==="Standard") ? 0.5 : 1;
  }

  if(pack!=="Essentiel"){
    addServiceLine("motion"); state.services[state.services.length-1].qty = days.md;
  }

  setNotesForPack(pack);
}

/* ==========
   Add-ons
   ========== */
function renderAddons(){
  el.addonsList.innerHTML = "";
  ADDONS.forEach(a=>{
    const div = document.createElement("div");
    div.className="check";
    div.innerHTML = `
      <input type="checkbox" id="addon_${a.id}" />
      <div>
        <div class="t">${a.name}</div>
        <div class="d">${a.desc}</div>
      </div>
    `;
    el.addonsList.appendChild(div);
  });
}
function addSelectedAddons(){
  ADDONS.forEach(a=>{
    const cb = document.getElementById("addon_"+a.id);
    if(cb && cb.checked){
      // motion design -> service line, otherwise fee line
      if(a.id.startsWith("md")){
        state.services.push({id:uid(), name:a.name, desc:a.desc, unit:a.unit, qty:a.qty, unitPrice:"", costUnit:0});
      } else {
        state.fees.push({id:uid(), name:a.name, desc:a.desc, unit:a.unit, qty:a.qty, unitPrice:"", costUnit:0});
      }
    }
  });
}

/* ==========
   Inventory select + roles select
   ========== */
function renderInventorySelect(){
  el.gearItem.innerHTML = "";
  INVENTORY.forEach((it, idx)=>{
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `[${it.source}] ${it.name} — ${fmtEUR(it.dayRate)}/j (J1) · dispo ${it.qtyAvail}`;
    el.gearItem.appendChild(opt);
  });
}
function injectRoleOptions(){
  const og = document.createElement("optgroup");
  og.label = "Rôles (heures — coûts depuis Calculateur)";
  ROLE_RATES.forEach((r, idx)=>{
    const o = document.createElement("option");
    o.value = "role:"+idx;
    o.textContent = `${r.section} — ${r.role} (${r.rate} €/h)`;
    og.appendChild(o);
  });
  el.serviceTemplate.appendChild(og);
}

/* ==========
   CSV inventory import
   ========== */
function importInventoryFromCSV(text){
  const lines = (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for(const l of lines){
    const sep = l.includes(";") ? ";" : (l.includes(",") ? "," : null);
    if(!sep) continue;
    const parts = l.split(sep).map(x=>x.trim());
    const name = parts[0];
    const rate = parseFloat((parts[1]||"").replace(",","."));
    const qty  = parts[2] ? parseInt(parts[2],10) : 1;
    if(name && Number.isFinite(rate)){
      out.push({name, dayRate:rate, qtyAvail: Number.isFinite(qty)? qty : 1, source:"CSV"});
    }
  }
  if(out.length){
    INVENTORY = out;
    renderInventorySelect();
    alert(`Inventaire importé (${out.length} items).`);
  } else {
    alert("CSV non reconnu. Attendu : nom;tarif_jour;quantité(optionnel)");
  }
}

/* ==========
   Refresh
   ========== */
function refresh(){
  syncStateFromInputs();
  el.customDegWrap.style.display = (el.degressivityPreset.value === "custom") ? "block" : "none";

  renderLinesTable(el.tblServices, state.services, "services");
  renderGearTable();
  renderLinesTable(el.tblFees, state.fees, "fees");

  el.countService.textContent = state.services.length;
  el.countGear.textContent = state.gear.length;
  el.countFees.textContent = state.fees.length;

  const t = totals();
  el.kpiSales.textContent = fmtEUR(t.sales);
  el.kpiCosts.textContent = fmtEUR(t.costs);
  el.kpiProfit.textContent = fmtEUR(t.profit);
  el.kpiProfitRate.textContent = fmtPct(t.profitRate);
  el.kpiSuggestSales.textContent = fmtEUR(t.suggestedSales);
  el.kpiTTC.textContent = fmtEUR(t.ttc);
  el.kpiTTC2.textContent = fmtEUR(t.ttc);

  const target = clamp(+el.targetMargin.value||0, 0, 0.95);
  const ok = (t.sales>0) && (t.profitRate >= target - 1e-6);
  el.kpiMargin.textContent = `${fmtPct(t.profitRate)} (cible ${fmtPct(target)})`;
  el.dotMargin.style.background = ok ? "var(--accent2)" : "var(--danger)";

  renderDoc();

  localStorage.setItem("mcp_quote_autosave_v2", JSON.stringify(state));
}

/* ==========
   Actions
   ========== */
function autoRepriceToTarget(){
  const target = clamp(+el.targetMargin.value||0, 0, 0.95);
  const den = Math.max(1 - target, 0.05);
  [...state.services, ...state.fees].forEach(l=>{
    l.unitPrice = (+l.costUnit||0) / den;
  });
  refresh();
}

function saveToLocal(){
  syncStateFromInputs();
  ensureQuoteRef();
  const key = "mcp_quote_saved_v2_" + state.meta.quoteRef;
  localStorage.setItem(key, JSON.stringify(state));
  alert(`Devis sauvegardé : ${state.meta.quoteRef}`);
  refresh();
}

function newQuote(){
  if(!confirm("Créer un nouveau devis ? (remplace le brouillon)")) return;
  const keepMcp = {...state.mcp};
  Object.assign(state, {
    meta:{...state.meta, quoteRef:""},
    mcp: keepMcp,
    client:{company:"",contact:"",email:"",phone:"",addr:"",ids:""},
    project:{title:"",place:"",dates:"",type:"Film institutionnel / corporate (image)",desc:""},
    services:[], gear:[], fees:[]
  });
  syncInputsFromState();
  refresh();
}

function exportJSON(){
  syncStateFromInputs();
  const ref = state.meta.quoteRef?.trim() ? state.meta.quoteRef.trim() : "DEVIS_MCP";
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${ref}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      Object.assign(state, obj);
      state.services = state.services || [];
      state.gear = state.gear || [];
      state.fees = state.fees || [];
      syncInputsFromState();
      refresh();
      alert("Import JSON OK.");
    } catch(e){
      alert("Import JSON impossible : fichier invalide.");
    }
  };
  reader.readAsText(file);
}

function bindAll(){
  document.querySelectorAll("input,select,textarea").forEach(x=>{
    if(["importFile","csvArea"].includes(x.id)) return;
    x.addEventListener("input", refresh);
    x.addEventListener("change", refresh);
  });

  el.addService.addEventListener("click", ()=>{ addServiceLine(el.serviceTemplate.value); refresh(); });
  el.clearServices.addEventListener("click", ()=>{ if(confirm("Supprimer toutes les prestations ?")){ state.services=[]; refresh(); }});

  el.addGear.addEventListener("click", ()=>{ addGearLine(+el.gearItem.value); refresh(); });

  el.addFee.addEventListener("click", ()=>{ addFeeLine(el.feeTemplate.value); refresh(); });
  el.clearFees.addEventListener("click", ()=>{ if(confirm("Supprimer tous les frais ?")){ state.fees=[]; refresh(); }});

  el.btnGeneratePack.addEventListener("click", ()=>{
    if(confirm("Générer le pack et remplacer toutes les lignes ?")){
      generatePack(el.catalogType.value, el.catalogPack.value);
      refresh();
    }
  });

  el.btnAddAddons.addEventListener("click", ()=>{ addSelectedAddons(); refresh(); });
  el.btnClearAddons.addEventListener("click", ()=>{
    ADDONS.forEach(a=>{
      const cb = document.getElementById("addon_"+a.id);
      if(cb) cb.checked=false;
    });
  });

  el.btnAutoReprice.addEventListener("click", autoRepriceToTarget);

  el.btnImportCSV.addEventListener("click", ()=>{
    const shown = el.csvArea.style.display !== "none";
    el.csvArea.style.display = shown ? "none" : "block";
    if(!shown) el.csvArea.focus();
    else{
      importInventoryFromCSV(el.csvArea.value);
      el.csvArea.value = "";
      refresh();
    }
  });

  el.btnNew.addEventListener("click", newQuote);
  el.btnSave.addEventListener("click", saveToLocal);
  el.btnExport.addEventListener("click", exportJSON);
  el.importFile.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value = "";
  });
  el.btnPrint.addEventListener("click", ()=>{
    syncStateFromInputs();
    ensureQuoteRef();
    refresh();
    window.print();
  });
}

function boot(){
  const auto = localStorage.getItem("mcp_quote_autosave_v2");
  if(auto){
    try{ Object.assign(state, JSON.parse(auto)); } catch(_) {}
  }
  syncInputsFromState();
  renderInventorySelect();
  injectRoleOptions();
  renderAddons();
  bindAll();
  refresh();
}

boot();
</script>
</body>
</html>
