<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCP — Générateur de devis (v3)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --text:#e9eeff;
      --muted:#b8c2ffcc;
      --line:#2a3a78;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --warn:#ffcf5c;
      --bad:#ff6b6b;

      /* +++ tailles champs +++ */
      --fs:15px;
      --fs-sm:13px;
      --input-h:46px;
      --pad:12px;
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(900px 500px at 10% 10%, #1a2550 0%, transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, #2b1b4c 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      font-size:var(--fs);
    }

    .wrap{max-width:1300px;margin:24px auto;padding:0 16px 48px}
    h1{margin:0 0 12px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:18px;line-height:1.35}

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background: rgba(0,0,0,.12);
    }
    .card .hd strong{font-size:14px;letter-spacing:.2px}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-bottom:10px}
    .row3{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;margin-bottom:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: var(--pad);
      min-height: var(--input-h);
      outline:none;
      font-size:var(--fs);
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(122,162,255,.7); box-shadow: 0 0 0 3px rgba(122,162,255,.18)}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(122,162,255,.14);
      color: var(--text);
      padding:12px 14px;
      border-radius: 12px;
      font-weight:600;
      letter-spacing:.2px;
      min-height: var(--input-h);
    }
    button:hover{background: rgba(122,162,255,.22)}
    .ghost{background: rgba(255,255,255,.06)}
    .danger{background: rgba(255,107,107,.15)}
    .danger:hover{background: rgba(255,107,107,.25)}
    .good{background: rgba(61,220,151,.14)}
    .good:hover{background: rgba(61,220,151,.22)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:700}

    .tablewrap{
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{
      position:sticky;top:0;z-index:2;
      background: rgba(15,23,48,.95);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 12px;
      vertical-align:middle;
    }
    tbody tr:hover td{background: rgba(255,255,255,.03)}
    .right{text-align:right}
    .center{text-align:center}

    /* +++ colonnes numériques plus larges +++ */
    .col-unit{min-width:120px}
    .col-qty{min-width:130px}
    .col-price{min-width:160px}
    .col-cost{min-width:160px}
    .col-total{min-width:170px}
    .col-actions{min-width:120px}

    .cell-input{
      min-height: var(--input-h);
      padding: 12px;
      font-size: var(--fs);
      border-radius:12px;
      width:100%;
    }
    .tiny{font-size:12px;color:var(--muted)}
    .split{
      display:grid;grid-template-columns:1fr 1fr;gap:14px;
    }
    .totals{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px
    }
    .kpi{
      padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:800;margin-top:4px}
    .kpi .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .ok{color:var(--good)}
    .no{color:var(--bad)}
    .mid{color:var(--warn)}

    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      table{min-width:1050px}
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>MCP — Générateur de devis (v3)</h1>
  <div class="sub">
    Champs agrandis + packs réellement préremplis (quantités + PU). Données intégrées depuis ton inventaire et ton calculateur.
  </div>

  <div class="grid">
    <!-- COLONNE GAUCHE -->
    <div class="card">
      <div class="hd">
        <strong>Informations devis</strong>
        <span class="pill">TVA <b id="pillVat">20%</b> · Objectif marge <b id="pillMargin">50%</b></span>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label>Numéro de devis</label>
            <input id="quoteNumber" class="cell-input" placeholder="MCP-2026-001" />
          </div>
          <div>
            <label>Date</label>
            <input id="quoteDate" class="cell-input" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Émis par</label>
            <input id="issuerName" class="cell-input" value="Momentum Creative Productions (MCP)" />
          </div>
          <div>
            <label>Régime TVA</label>
            <input id="vatRegime" class="cell-input" value="Assujetti TVA — Régime simplifié" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Client</label>
            <input id="clientName" class="cell-input" placeholder="Entreprise / organisme" />
          </div>
          <div>
            <label>Contact</label>
            <input id="clientContact" class="cell-input" placeholder="Nom + email + téléphone" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Projet</label>
            <input id="projectName" class="cell-input" placeholder="Film corporate / Live interne / ..." />
          </div>
          <div>
            <label>Lieu</label>
            <input id="projectPlace" class="cell-input" placeholder="Lyon / sur site client / ..." />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Mode de prix</label>
            <select id="pricingMode" class="cell-input">
              <option value="margin">Prix conseillé (marge-cible)</option>
              <option value="manual">Prix manuel (PU saisis)</option>
            </select>
          </div>
          <div>
            <label>Objectif marge (bénéfice / HT)</label>
            <input id="targetMargin" class="cell-input" type="number" step="0.01" min="0" max="0.95" value="0.50" />
          </div>
          <div>
            <label>TVA</label>
            <input id="vatRate" class="cell-input" type="number" step="0.01" min="0" max="1" value="0.20" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Coût matériel — amortissement (jours facturés)</label>
            <input id="amortDays" class="cell-input" type="number" min="10" step="1" value="120" />
          </div>
          <div>
            <label>Fallback coût/j si achat inconnu (part du PU)</label>
            <input id="fallbackGearCostShare" class="cell-input" type="number" min="0" max="1" step="0.05" value="0.40" />
          </div>
          <div>
            <label>Préremplir les PU lors du chargement de pack</label>
            <select id="prefillPU" class="cell-input">
              <option value="yes" selected>Oui</option>
              <option value="no">Non</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="hd">
            <strong>Charger un pack</strong>
            <span class="pill">Remplit services + matériel</span>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>Type</label>
                <select id="packType" class="cell-input">
                  <option value="film">Film corporate</option>
                  <option value="aftermovie">Aftermovie</option>
                  <option value="live_teams">Live interne (Teams / table ronde)</option>
                  <option value="live_talkshow">Live talk-show (multi-cam)</option>
                </select>
              </div>
              <div>
                <label>Niveau</label>
                <select id="packLevel" class="cell-input">
                  <option value="essentiel">Essentiel</option>
                  <option value="standard" selected>Standard</option>
                  <option value="premium">Premium</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button id="btnLoadPack" class="good">Charger le pack (remplacer)</button>
              <button id="btnAppendPack" class="ghost">Ajouter le pack (garder lignes)</button>
              <button id="btnReset" class="danger">Réinitialiser</button>
            </div>
            <div class="tiny" style="margin-top:8px">
              Les PU sont calculés en “marge-cible” à partir d’un coût interne estimé (rôles & heures) + tes tarifs loc/jour.
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="btns">
          <button id="btnPrint" class="ghost">Imprimer / PDF</button>
          <button id="btnExportJson" class="ghost">Exporter JSON</button>
          <button id="btnImportJson" class="ghost">Importer JSON</button>
          <input id="jsonFile" type="file" accept="application/json" style="display:none" />
        </div>

        <div style="margin-top:12px">
          <label>Notes / conditions (optionnel)</label>
          <textarea id="notes" class="cell-input" placeholder="Délais, conditions de paiement, droits, etc."></textarea>
        </div>
      </div>
    </div>

    <!-- COLONNE DROITE -->
    <div class="card">
      <div class="hd">
        <strong>Prestations & matériel</strong>
        <span class="pill">HT + marge + TVA calculés</span>
      </div>
      <div class="bd">

        <div class="split">
          <div>
            <div class="pill" style="margin-bottom:10px">1) Services</div>
            <div class="tablewrap">
              <table id="servicesTable">
                <thead>
                  <tr>
                    <th>Intitulé</th>
                    <th>Description</th>
                    <th class="col-unit">Unité</th>
                    <th class="right col-qty">Qté</th>
                    <th class="right col-price">PU vente</th>
                    <th class="right col-cost">Coût interne</th>
                    <th class="right col-total">Total</th>
                    <th class="center col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="btns" style="margin-top:10px">
              <button id="btnAddService">+ Ligne service</button>
            </div>
          </div>

          <div>
            <div class="pill" style="margin-bottom:10px">2) Matériel (loc / jour)</div>
            <div class="tablewrap">
              <table id="gearTable">
                <thead>
                  <tr>
                    <th>Matériel</th>
                    <th class="right col-qty">Qté</th>
                    <th class="right col-qty">Jours</th>
                    <th class="right col-price">PU / jour</th>
                    <th class="right col-cost">Coût / jour (estim.)</th>
                    <th class="right col-total">Total</th>
                    <th class="center col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="btns" style="margin-top:10px">
              <button id="btnAddGear">+ Ligne matériel</button>
            </div>
            <div class="tiny" style="margin-top:6px">
              Coût matériel estimé = (prix d’achat / amortissement) sinon fallback = % du PU.
            </div>
          </div>
        </div>

        <div class="totals" id="totalsBlock"></div>

      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   Données (depuis tes fichiers)
   ======================= */

const INVENTORY = ${inv_full_json};

const ROLE_RATES = ${roles_json};

/* =======================
   État
   ======================= */

const state = {
  meta: {
    quoteNumber: "",
    quoteDate: "",
    issuerName: "Momentum Creative Productions (MCP)",
    vatRegime: "Assujetti TVA — Régime simplifié",
    clientName: "",
    clientContact: "",
    projectName: "",
    projectPlace: "",
    notes: ""
  },
  pricing: {
    mode: "margin",           // "margin" | "manual"
    targetMargin: 0.50,       // bénéfice / HT
    vatRate: 0.20
  },
  gearCost: {
    amortDays: 120,
    fallbackShare: 0.40
  },
  prefs: {
    prefillPU: true
  },
  services: [],
  gear: []
};

/* =======================
   Helpers
   ======================= */
const € = (n) => (isFinite(n) ? n.toFixed(2) + " €" : "—");
const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
const num = (v, fallback=0) => {
  const x = Number(v);
  return Number.isFinite(x) ? x : fallback;
};

function roleRate(roleName){
  const r = ROLE_RATES.find(x => x.role === roleName);
  return r ? Number(r.rate) : 0;
}

function costFromRoles(hoursMap){
  // hoursMap: { "Role": heures, ... }
  let total = 0;
  for (const [role, h] of Object.entries(hoursMap)){
    total += roleRate(role) * Number(h);
  }
  return total;
}

function suggestedPU(costUnit){
  // PU = coût / (1 - marge-cible)
  const m = clamp(state.pricing.targetMargin, 0, 0.95);
  if (!isFinite(costUnit) || costUnit <= 0) return 0;
  return costUnit / (1 - m);
}

function gearCostPerDay(invItem){
  const amort = Math.max(10, num(state.gearCost.amortDays, 120));
  if (invItem && invItem.purchasePrice && isFinite(invItem.purchasePrice) && invItem.purchasePrice > 0){
    return invItem.purchasePrice / amort;
  }
  const fallback = clamp(num(state.gearCost.fallbackShare, 0.4), 0, 1);
  return (invItem ? invItem.dayRate : 0) * fallback;
}

function invFind(keyword){
  const k = (keyword || "").toLowerCase();
  if (!k) return -1;
  return INVENTORY.findIndex(it => (it.name || "").toLowerCase().includes(k));
}

function addServiceLine({name, desc="", unit="jour", qty=1, costUnit=0, unitPrice=null}){
  const pu = (unitPrice === null)
    ? (state.prefs.prefillPU && state.pricing.mode === "margin" ? suggestedPU(costUnit) : 0)
    : unitPrice;

  state.services.push({
    name, desc, unit,
    qty: num(qty,1),
    costUnit: num(costUnit,0),
    unitPrice: num(pu,0)
  });
}

function addGearLine({invIndex, qty=1, days=1, unitPrice=null, costPerDay=null}){
  const it = INVENTORY[invIndex] || null;
  const pu = (unitPrice === null) ? (it ? it.dayRate : 0) : unitPrice;
  const cpd = (costPerDay === null) ? (it ? gearCostPerDay(it) : 0) : costPerDay;

  state.gear.push({
    invIndex,
    qty: num(qty,1),
    days: num(days,1),
    unitPrice: num(pu,0),
    costPerDay: num(cpd,0)
  });
}

function addGearByKeyword(keyword, qty, days){
  const idx = invFind(keyword);
  if (idx >= 0) addGearLine({invIndex: idx, qty, days});
  else {
    // si pas trouvé : on n'ajoute rien (évite lignes “vides”)
    console.warn("Matériel introuvable dans inventaire:", keyword);
  }
}

/* =======================
   Packs (préremplis)
   ======================= */

const COST = {
  preprodDay: () => costFromRoles({"Organisation":6, "Script/Storyboard":2}), // 8h à 50€
  shootDayLight: () => costFromRoles({"Chef opérateur":8, "Ingénieur du son":4, "Chef électricien":4}),
  eventShootDay: () => costFromRoles({"Cadreur":8, "Ingénieur du son":2}),
  liveDay: () => costFromRoles({"Réalisateur":8, "Monteur vision (switcher)":8, "Technicien vidéo":8, "Ingénieur du son":8}),
  editDay: () => costFromRoles({"Chef monteur":8, "Assistant monteur":2}),
  colorHalfDay: () => costFromRoles({"Étalonneur":4}),
  soundHalfDay: () => costFromRoles({"Monteur son":4}),
  motionHalfDay: () => costFromRoles({"Graphiste habillages":4}),
  deliveryForfait: () => costFromRoles({"Assistant monteur":1})
};

const PACKS = {
  film: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Cadrage, préparation, script léger", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"1 journée — équipe légère", unit:"jour", qty:1, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Sélection + montage + exports", unit:"jour", qty:2, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports + livraison + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      // Matériel film (1 jour tournage)
      addGearByKeyword("FX6", 1, 1);
      addGearByKeyword("FE 28-70mm", 1, 1);
      addGearByKeyword("Nitrotech", 1, 1);
      addGearByKeyword("Forza 60B", 2, 1);
      addGearByKeyword("Pied lumière standard", 4, 1);
    },

    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Cadrage, repérage léger, script", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"1,5 journée — interviews + plans d’illustration", unit:"jour", qty:1.5, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Montage + versions + exports", unit:"jour", qty:3, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Cohérence colorimétrique", unit:"jour", qty:0.5, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Montage son / mix", desc:"Nettoyage, équilibre, export", unit:"jour", qty:0.5, costUnit:COST.soundHalfDay()});
      addServiceLine({name:"Habillage léger", desc:"Titres, lower thirds simples", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports + livraison + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 1);
      addGearByKeyword("Nucleus", 1, 1);
      addGearByKeyword("Forza 60B", 2, 2);
      addGearByKeyword("Forza FS 300", 1, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    },

    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Cadrage complet, script, planning, repérage", unit:"jour", qty:3, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"3 journées — interviews + b-roll avancé", unit:"jour", qty:3, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Montage avancé + itérations", unit:"jour", qty:6, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Color grading", unit:"jour", qty:1, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Montage son / mix", desc:"Nettoyage + mix", unit:"jour", qty:1, costUnit:COST.soundHalfDay()});
      addServiceLine({name:"Habillage", desc:"Titres + animations simples", unit:"jour", qty:1, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports multi-formats + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("FX6", 1, 3);
      addGearByKeyword("FE 28-70mm", 1, 3);
      addGearByKeyword("Irix Cine", 1, 2);
      addGearByKeyword("Nitrotech", 1, 3);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("Nucleus", 1, 2);
      addGearByKeyword("Forza 60B", 4, 3);
      addGearByKeyword("Forza FS 300", 1, 3);
      addGearByKeyword("Pied lumière standard", 6, 3);
    }
  },

  aftermovie: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Brief + organisation", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"Couverture 1 journée", unit:"jour", qty:1, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie 60–120s", unit:"jour", qty:1.5, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("FX6", 1, 1);
      addGearByKeyword("Ronin RS4 Pro", 1, 1);
      addGearByKeyword("FE 28-70mm", 1, 1);
      addGearByKeyword("Nitrotech", 1, 1);
      addGearByKeyword("Forza 60B", 2, 1);
      addGearByKeyword("Pied lumière standard", 4, 1);
    },

    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Brief + déroulé + plan de tournage", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"1 à 2 journées", unit:"jour", qty:1.5, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie + cutdowns réseaux", unit:"jour", qty:2.5, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Cohérence look", unit:"jour", qty:0.5, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Forza 60B", 2, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    },

    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Pré-production", desc:"Organisation + script + coordination", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"2 journées", unit:"jour", qty:2, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie + versions multiples + itérations", unit:"jour", qty:4, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Look final", unit:"jour", qty:1, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Habillage", desc:"Titres + animations", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports multi-formats", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Irix Cine", 1, 1);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Forza 60B", 4, 2);
      addGearByKeyword("Forza FS 300", 1, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    }
  },

  live_teams: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Préparation live", desc:"Brief + plan technique + tests", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée — table ronde / Q&R", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Livraison replay", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      // Matériel live minimal
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);

      // Caméras (2 PTZ)
      addGearByKeyword("AW-UE145", 2, 1);
      addGearByKeyword("AW-RP150G", 1, 1);

      // Audio
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 2, 1);
      addGearByKeyword("Récepteur HF", 2, 1);
      addGearByKeyword("Pied micro", 2, 1);

      // Câbles (tourets)
      addGearByKeyword("Touret combo", 1, 1);
      addGearByKeyword("Touret SDI", 1, 1);
      addGearByKeyword("Touret RJ45", 1, 1);
    },

    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Préparation live", desc:"Brief + conduite + tests + répétition", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage léger replay", desc:"Nettoyage début/fin + export", unit:"jour", qty:0.5, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison replay", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);

      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);

      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 4, 1);
      addGearByKeyword("Récepteur HF", 4, 1);
      addGearByKeyword("Pied micro", 4, 1);

      addGearByKeyword("Touret combo", 1, 1);
      addGearByKeyword("Touret SDI", 2, 1);
      addGearByKeyword("Touret RJ45", 1, 1);
    },

    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Préparation live", desc:"Plan technique + conduite + répétitions", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Nettoyage + chapitrage léger", unit:"jour", qty:1, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage live", desc:"Lower thirds + visuels simples", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison", desc:"Exports + livraison + archivage", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);

      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);

      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 6, 1);
      addGearByKeyword("Récepteur HF", 6, 1);
      addGearByKeyword("Pied micro", 6, 1);

      addGearByKeyword('75" + pied', 1, 1);

      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 2, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
    }
  },

  live_talkshow: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      // talk-show “essentiel” = proche standard live + plus d’audio
      PACKS.live_teams.standard(append);

      addServiceLine({name:"Cadrage plateau / répétition", desc:"Brief plateau + répétition", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      // Matériel additionnel léger
      addGearByKeyword("Moniteur rack", 1, 1);
      addGearByKeyword("Carte son", 1, 1);
    },

    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Préparation talk-show", desc:"Conduite + plan plateau + répétition", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée — talk-show", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Nettoyage + export + versions", unit:"jour", qty:1, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage", desc:"Titres + lower thirds", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / archivage", desc:"Exports + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);

      // 3 cam PTZ + pieds cam
      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("Pied + embase noire", 3, 1);

      // Audio plateau
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 4, 1);
      addGearByKeyword("Récepteur HF", 4, 1);
      addGearByKeyword("Pied micro", 4, 1);

      addGearByKeyword('75" + pied', 1, 1);

      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 3, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
    },

    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }

      addServiceLine({name:"Préparation talk-show", desc:"Cadrage + conduite + répétitions + habillages", unit:"jour", qty:2, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Replay + chapitrage + cutdowns", unit:"jour", qty:2, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage", desc:"Pack titres + lower thirds + animations simples", unit:"jour", qty:1, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / archivage", desc:"Exports multi-formats + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);

      // 3 PTZ + 1 URSA
      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("URSA Broadcast G2", 1, 1);
      addGearByKeyword("Transmission vidéo", 2, 1);
      addGearByKeyword("Pied + embase noire", 4, 1);

      // Audio renforcé
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 6, 1);
      addGearByKeyword("Récepteur HF", 6, 1);
      addGearByKeyword("Pied micro", 6, 1);
      addGearByKeyword('75" + pied', 1, 1);

      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 4, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
      addGearByKeyword("Touret HDMI", 1, 1);
    }
  }
};

/* =======================
   UI bindings
   ======================= */
const els = {
  quoteNumber: document.getElementById("quoteNumber"),
  quoteDate: document.getElementById("quoteDate"),
  issuerName: document.getElementById("issuerName"),
  vatRegime: document.getElementById("vatRegime"),
  clientName: document.getElementById("clientName"),
  clientContact: document.getElementById("clientContact"),
  projectName: document.getElementById("projectName"),
  projectPlace: document.getElementById("projectPlace"),
  notes: document.getElementById("notes"),

  pricingMode: document.getElementById("pricingMode"),
  targetMargin: document.getElementById("targetMargin"),
  vatRate: document.getElementById("vatRate"),

  amortDays: document.getElementById("amortDays"),
  fallbackGearCostShare: document.getElementById("fallbackGearCostShare"),
  prefillPU: document.getElementById("prefillPU"),

  packType: document.getElementById("packType"),
  packLevel: document.getElementById("packLevel"),

  pillVat: document.getElementById("pillVat"),
  pillMargin: document.getElementById("pillMargin"),

  servicesTable: document.querySelector("#servicesTable tbody"),
  gearTable: document.querySelector("#gearTable tbody"),
  totalsBlock: document.getElementById("totalsBlock"),

  btnAddService: document.getElementById("btnAddService"),
  btnAddGear: document.getElementById("btnAddGear"),
  btnLoadPack: document.getElementById("btnLoadPack"),
  btnAppendPack: document.getElementById("btnAppendPack"),
  btnReset: document.getElementById("btnReset"),
  btnPrint: document.getElementById("btnPrint"),
  btnExportJson: document.getElementById("btnExportJson"),
  btnImportJson: document.getElementById("btnImportJson"),
  jsonFile: document.getElementById("jsonFile"),
};

function syncMetaFromUI(){
  state.meta.quoteNumber = els.quoteNumber.value.trim();
  state.meta.quoteDate = els.quoteDate.value;
  state.meta.issuerName = els.issuerName.value.trim();
  state.meta.vatRegime = els.vatRegime.value.trim();
  state.meta.clientName = els.clientName.value.trim();
  state.meta.clientContact = els.clientContact.value.trim();
  state.meta.projectName = els.projectName.value.trim();
  state.meta.projectPlace = els.projectPlace.value.trim();
  state.meta.notes = els.notes.value.trim();
}

function syncPricingFromUI(){
  state.pricing.mode = els.pricingMode.value;
  state.pricing.targetMargin = clamp(num(els.targetMargin.value, 0.5), 0, 0.95);
  state.pricing.vatRate = clamp(num(els.vatRate.value, 0.2), 0, 1);

  state.gearCost.amortDays = Math.max(10, Math.floor(num(els.amortDays.value, 120)));
  state.gearCost.fallbackShare = clamp(num(els.fallbackGearCostShare.value, 0.4), 0, 1);

  state.prefs.prefillPU = (els.prefillPU.value === "yes");

  els.pillVat.textContent = Math.round(state.pricing.vatRate*100) + "%";
  els.pillMargin.textContent = Math.round(state.pricing.targetMargin*100) + "%";
}

/* =======================
   Rendering
   ======================= */

function render(){
  syncMetaFromUI();
  syncPricingFromUI();

  renderServices();
  renderGear();
  renderTotals();
}

function makeInput(value, type="text", onChange){
  const i = document.createElement("input");
  i.className = "cell-input";
  i.type = type;
  i.value = value ?? "";
  i.addEventListener("input", () => onChange(i.value));
  return i;
}

function makeSelect(options, value, onChange){
  const s = document.createElement("select");
  s.className = "cell-input";
  for (const opt of options){
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    if (opt.value === value) o.selected = true;
    s.appendChild(o);
  }
  s.addEventListener("change", () => onChange(s.value));
  return s;
}

function iconBtn(text, cls, onClick){
  const b = document.createElement("button");
  b.textContent = text;
  b.className = cls;
  b.style.minHeight = "40px";
  b.style.padding = "10px 12px";
  b.addEventListener("click", onClick);
  return b;
}

function lineTotalService(line){
  const qty = num(line.qty,0);
  const pu = (state.pricing.mode === "margin") ? (line.costUnit>0 ? suggestedPU(line.costUnit) : num(line.unitPrice,0)) : num(line.unitPrice,0);
  return qty * pu;
}
function lineCostService(line){
  return num(line.qty,0) * num(line.costUnit,0);
}

function renderServices(){
  els.servicesTable.innerHTML = "";
  state.services.forEach((line, idx) => {
    const tr = document.createElement("tr");

    // Intitulé
    const tdName = document.createElement("td");
    tdName.appendChild(makeInput(line.name, "text", v => { line.name = v; renderTotals(); }));
    tr.appendChild(tdName);

    // Desc
    const tdDesc = document.createElement("td");
    tdDesc.appendChild(makeInput(line.desc, "text", v => { line.desc = v; }));
    tr.appendChild(tdDesc);

    // Unité
    const tdUnit = document.createElement("td"); tdUnit.className="col-unit";
    tdUnit.appendChild(makeSelect([
      {value:"jour", label:"jour"},
      {value:"h", label:"h"},
      {value:"forfait", label:"forfait"},
    ], line.unit, v => { line.unit = v; }));
    tr.appendChild(tdUnit);

    // Qté
    const tdQty = document.createElement("td"); tdQty.className="right col-qty";
    const qtyInput = makeInput(line.qty, "number", v => { line.qty = num(v,0); renderTotals(); });
    qtyInput.step="0.25"; qtyInput.min="0";
    tdQty.appendChild(qtyInput);
    tr.appendChild(tdQty);

    // PU vente
    const tdPU = document.createElement("td"); tdPU.className="right col-price";
    const shownPU = (state.pricing.mode==="margin")
      ? (line.costUnit>0 ? suggestedPU(line.costUnit) : num(line.unitPrice,0))
      : num(line.unitPrice,0);
    const puInput = makeInput(shownPU, "number", v => { line.unitPrice = num(v,0); renderTotals(); });
    puInput.step="1"; puInput.min="0";
    tdPU.appendChild(puInput);
    tr.appendChild(tdPU);

    // Coût interne
    const tdCost = document.createElement("td"); tdCost.className="right col-cost";
    const costInput = makeInput(line.costUnit, "number", v => { line.costUnit = num(v,0); renderTotals(); });
    costInput.step="1"; costInput.min="0";
    tdCost.appendChild(costInput);
    tr.appendChild(tdCost);

    // Total
    const tdTot = document.createElement("td"); tdTot.className="right col-total";
    tdTot.textContent = €(lineTotalService(line));
    tr.appendChild(tdTot);

    // Actions
    const tdAct = document.createElement("td"); tdAct.className="center col-actions";
    const bDel = iconBtn("Suppr.", "danger", () => { state.services.splice(idx,1); render(); });
    tdAct.appendChild(bDel);
    tr.appendChild(tdAct);

    els.servicesTable.appendChild(tr);
  });
}

function lineTotalGear(g){
  return num(g.qty,0) * num(g.days,0) * num(g.unitPrice,0);
}
function lineCostGear(g){
  return num(g.qty,0) * num(g.days,0) * num(g.costPerDay,0);
}

function renderGear(){
  els.gearTable.innerHTML = "";
  state.gear.forEach((g, idx) => {
    const tr = document.createElement("tr");

    // Select item
    const tdItem = document.createElement("td");
    const s = document.createElement("select");
    s.className = "cell-input";
    INVENTORY.forEach((it, i) => {
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = `${it.name}  —  ${it.dayRate.toFixed(2)}€/j  (${it.source})`;
      if (i === g.invIndex) o.selected = true;
      s.appendChild(o);
    });
    s.addEventListener("change", () => {
      g.invIndex = Number(s.value);
      const it = INVENTORY[g.invIndex];
      g.unitPrice = it.dayRate;
      g.costPerDay = gearCostPerDay(it);
      render();
    });
    tdItem.appendChild(s);
    tr.appendChild(tdItem);

    // qty
    const tdQty = document.createElement("td"); tdQty.className="right col-qty";
    const iQty = makeInput(g.qty, "number", v => { g.qty = num(v,0); renderTotals(); });
    iQty.step="1"; iQty.min="0";
    tdQty.appendChild(iQty);
    tr.appendChild(tdQty);

    // days
    const tdDays = document.createElement("td"); tdDays.className="right col-qty";
    const iDays = makeInput(g.days, "number", v => { g.days = num(v,0); renderTotals(); });
    iDays.step="0.5"; iDays.min="0";
    tdDays.appendChild(iDays);
    tr.appendChild(tdDays);

    // pu/day
    const tdPU = document.createElement("td"); tdPU.className="right col-price";
    const iPU = makeInput(g.unitPrice, "number", v => { g.unitPrice = num(v,0); renderTotals(); });
    iPU.step="1"; iPU.min="0";
    tdPU.appendChild(iPU);
    tr.appendChild(tdPU);

    // cost/day
    const tdCost = document.createElement("td"); tdCost.className="right col-cost";
    const iCost = makeInput(g.costPerDay, "number", v => { g.costPerDay = num(v,0); renderTotals(); });
    iCost.step="1"; iCost.min="0";
    tdCost.appendChild(iCost);
    tr.appendChild(tdCost);

    // total
    const tdTot = document.createElement("td"); tdTot.className="right col-total";
    tdTot.textContent = €(lineTotalGear(g));
    tr.appendChild(tdTot);

    // actions
    const tdAct = document.createElement("td"); tdAct.className="center col-actions";
    tdAct.appendChild(iconBtn("Suppr.", "danger", () => { state.gear.splice(idx,1); render(); }));
    tr.appendChild(tdAct);

    els.gearTable.appendChild(tr);
  });
}

function renderTotals(){
  // totals = services + gear
  const htServices = state.services.reduce((s,l)=>s+lineTotalService(l),0);
  const htGear = state.gear.reduce((s,g)=>s+lineTotalGear(g),0);
  const ht = htServices + htGear;

  const costServices = state.services.reduce((s,l)=>s+lineCostService(l),0);
  const costGear = state.gear.reduce((s,g)=>s+lineCostGear(g),0);
  const cost = costServices + costGear;

  const profit = ht - cost;
  const profitShare = ht > 0 ? profit / ht : 0;

  const vat = ht * state.pricing.vatRate;
  const ttc = ht + vat;

  const target = state.pricing.targetMargin;
  const cls = profitShare >= target ? "ok" : (profitShare >= target*0.8 ? "mid" : "no");
  const cls2 = ht>0 ? cls : "mid";

  els.totalsBlock.innerHTML = `
    <div class="kpi">
      <div class="lab">Total HT</div>
      <div class="val">${€(ht)}</div>
      <div class="hint">Services: ${€(htServices)} · Matériel: ${€(htGear)}</div>
    </div>
    <div class="kpi">
      <div class="lab">TVA (${Math.round(state.pricing.vatRate*100)}%)</div>
      <div class="val">${€(vat)}</div>
      <div class="hint">Total TTC: <b>${€(ttc)}</b></div>
    </div>
    <div class="kpi">
      <div class="lab">Marge / bénéfice estimé</div>
      <div class="val ${cls2}">${€(profit)}</div>
      <div class="hint ${cls2}">
        ${Math.round(profitShare*100)}% du HT · objectif ${Math.round(target*100)}%
      </div>
    </div>
  `;
}

/* =======================
   Actions
   ======================= */

function loadPack(append=false){
  syncPricingFromUI();

  const type = els.packType.value;
  const level = els.packLevel.value;

  if (!PACKS[type] || !PACKS[type][level]){
    alert("Pack introuvable.");
    return;
  }
  PACKS[type][level](append);

  // si mode margin, et prefillPU, on recalc automatiquement l’affichage (les PU visibles)
  render();
}

els.btnLoadPack.addEventListener("click", () => loadPack(false));
els.btnAppendPack.addEventListener("click", () => loadPack(true));

els.btnReset.addEventListener("click", () => {
  state.services = [];
  state.gear = [];
  render();
});

els.btnAddService.addEventListener("click", () => {
  addServiceLine({name:"Nouvelle prestation", desc:"", unit:"jour", qty:1, costUnit:0, unitPrice:0});
  render();
});

els.btnAddGear.addEventListener("click", () => {
  addGearLine({invIndex: 0, qty:1, days:1});
  render();
});

els.btnPrint.addEventListener("click", () => window.print());

els.btnExportJson.addEventListener("click", () => {
  syncMetaFromUI(); syncPricingFromUI();
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (state.meta.quoteNumber || "devis_mcp") + ".json";
  a.click();
  URL.revokeObjectURL(a.href);
});

els.btnImportJson.addEventListener("click", () => els.jsonFile.click());
els.jsonFile.addEventListener("change", async () => {
  const f = els.jsonFile.files[0];
  if (!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    // merge simple
    Object.assign(state.meta, obj.meta || {});
    Object.assign(state.pricing, obj.pricing || {});
    Object.assign(state.gearCost, obj.gearCost || {});
    Object.assign(state.prefs, obj.prefs || {});
    state.services = Array.isArray(obj.services) ? obj.services : [];
    state.gear = Array.isArray(obj.gear) ? obj.gear : [];

    // repush meta to UI
    els.quoteNumber.value = state.meta.quoteNumber || "";
    els.quoteDate.value = state.meta.quoteDate || "";
    els.issuerName.value = state.meta.issuerName || "";
    els.vatRegime.value = state.meta.vatRegime || "";
    els.clientName.value = state.meta.clientName || "";
    els.clientContact.value = state.meta.clientContact || "";
    els.projectName.value = state.meta.projectName || "";
    els.projectPlace.value = state.meta.projectPlace || "";
    els.notes.value = state.meta.notes || "";

    els.pricingMode.value = state.pricing.mode || "margin";
    els.targetMargin.value = state.pricing.targetMargin ?? 0.5;
    els.vatRate.value = state.pricing.vatRate ?? 0.2;

    els.amortDays.value = state.gearCost.amortDays ?? 120;
    els.fallbackGearCostShare.value = state.gearCost.fallbackShare ?? 0.4;
    els.prefillPU.value = state.prefs.prefillPU ? "yes" : "no";

    render();
  }catch(e){
    alert("JSON invalide.");
  }finally{
    els.jsonFile.value = "";
  }
});

// live updates
[
  els.quoteNumber, els.quoteDate, els.issuerName, els.vatRegime,
  els.clientName, els.clientContact, els.projectName, els.projectPlace, els.notes,
  els.pricingMode, els.targetMargin, els.vatRate,
  els.amortDays, els.fallbackGearCostShare, els.prefillPU
].forEach(el => el.addEventListener("input", render));
[els.pricingMode, els.prefillPU].forEach(el => el.addEventListener("change", render));

// init date
(function init(){
  const d = new Date();
  const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  els.quoteDate.value = iso;
  els.quoteNumber.value = "MCP-" + d.getFullYear() + "-001";
  render();
})();
</script>

</body>
</html>
