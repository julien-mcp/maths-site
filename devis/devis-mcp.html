<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCP — Générateur de devis (v3.1 FIX)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --text:#e9eeff;
      --muted:#b8c2ffcc;
      --line:#2a3a78;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --warn:#ffcf5c;
      --bad:#ff6b6b;

      --fs:15px;
      --input-h:46px;
      --pad:12px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 10% 10%, #1a2550 0%, transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, #2b1b4c 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      font-size:var(--fs);
    }
    .wrap{max-width:1300px;margin:24px auto;padding:0 16px 48px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:18px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:14px;align-items:start}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background: rgba(0,0,0,.12);
    }
    .card .hd strong{font-size:14px;letter-spacing:.2px}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-bottom:10px}
    .row3{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;margin-bottom:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: var(--pad);
      min-height: var(--input-h);
      outline:none;
      font-size:var(--fs);
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(122,162,255,.7); box-shadow: 0 0 0 3px rgba(122,162,255,.18)}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(122,162,255,.14);
      color: var(--text);
      padding:12px 14px;
      border-radius: 12px;
      font-weight:600;
      letter-spacing:.2px;
      min-height: var(--input-h);
    }
    button:hover{background: rgba(122,162,255,.22)}
    .ghost{background: rgba(255,255,255,.06)}
    .danger{background: rgba(255,107,107,.15)}
    .danger:hover{background: rgba(255,107,107,.25)}
    .good{background: rgba(61,220,151,.14)}
    .good:hover{background: rgba(61,220,151,.22)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:700}

    .tablewrap{
      overflow:auto;border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{
      position:sticky;top:0;z-index:2;
      background: rgba(15,23,48,.95);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;font-size:12px;color:var(--muted);
      padding:12px;white-space:nowrap;
    }
    tbody td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px 12px;vertical-align:middle}
    tbody tr:hover td{background: rgba(255,255,255,.03)}
    .right{text-align:right}
    .center{text-align:center}

    .col-unit{min-width:120px}
    .col-qty{min-width:130px}
    .col-price{min-width:160px}
    .col-cost{min-width:160px}
    .col-total{min-width:170px}
    .col-actions{min-width:120px}

    .cell-input{min-height: var(--input-h);padding: 12px;font-size: var(--fs);border-radius:12px;width:100%}
    .tiny{font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 1100px){.split{grid-template-columns:1fr}}
    .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
    .kpi{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.12)}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:800;margin-top:4px}
    .kpi .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .ok{color:var(--good)}
    .no{color:var(--bad)}
    .mid{color:var(--warn)}

    @media print{
      body{background:white;color:black}
      .card{box-shadow:none;border:1px solid #ddd}
      .sub{color:#444}
      input,select,textarea{border:1px solid #ddd;background:white;color:black}
      .btns{display:none !important}
      .pill{border:1px solid #ddd;color:#444;background:white}
      thead th{position:static;background:#f5f5f5;color:#333}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>MCP — Générateur de devis (v3.1 FIX)</h1>
  <div class="sub">Version corrigée : script autonome (plus de placeholders), packs préremplis, et recalculs fiables.</div>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <strong>Informations devis</strong>
        <span class="pill">TVA <b id="pillVat">20%</b> · Objectif marge <b id="pillMargin">50%</b></span>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label>Numéro de devis</label>
            <input id="quoteNumber" class="cell-input" placeholder="MCP-2026-001" />
          </div>
          <div>
            <label>Date</label>
            <input id="quoteDate" class="cell-input" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Émis par</label>
            <input id="issuerName" class="cell-input" value="Momentum Creative Productions (MCP)" />
          </div>
          <div>
            <label>Régime TVA</label>
            <input id="vatRegime" class="cell-input" value="Assujetti TVA — Régime simplifié" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Client</label>
            <input id="clientName" class="cell-input" placeholder="Entreprise / organisme" />
          </div>
          <div>
            <label>Contact</label>
            <input id="clientContact" class="cell-input" placeholder="Nom + email + téléphone" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Projet</label>
            <input id="projectName" class="cell-input" placeholder="Film corporate / Live interne / ..." />
          </div>
          <div>
            <label>Lieu</label>
            <input id="projectPlace" class="cell-input" placeholder="Lyon / sur site client / ..." />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Mode de prix</label>
            <select id="pricingMode" class="cell-input">
              <option value="margin">Prix conseillé (marge-cible)</option>
              <option value="manual">Prix manuel (PU saisis)</option>
            </select>
          </div>
          <div>
            <label>Objectif marge (bénéfice / HT)</label>
            <input id="targetMargin" class="cell-input" type="number" step="0.01" min="0" max="0.95" value="0.50" />
          </div>
          <div>
            <label>TVA</label>
            <input id="vatRate" class="cell-input" type="number" step="0.01" min="0" max="1" value="0.20" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Coût matériel — amortissement (jours facturés)</label>
            <input id="amortDays" class="cell-input" type="number" min="10" step="1" value="120" />
          </div>
          <div>
            <label>Fallback coût/j si achat inconnu (% du PU)</label>
            <input id="fallbackGearCostShare" class="cell-input" type="number" min="0" max="1" step="0.05" value="0.40" />
          </div>
          <div>
            <label>Préremplir PU lors du chargement de pack</label>
            <select id="prefillPU" class="cell-input">
              <option value="yes" selected>Oui</option>
              <option value="no">Non</option>
            </select>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hd">
            <strong>Charger un pack</strong>
            <span class="pill">Remplit services + matériel</span>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>Type</label>
                <select id="packType" class="cell-input">
                  <option value="film">Film corporate</option>
                  <option value="aftermovie">Aftermovie</option>
                  <option value="live_teams">Live interne (Teams / table ronde)</option>
                  <option value="live_talkshow">Live talk-show (multi-cam)</option>
                </select>
              </div>
              <div>
                <label>Niveau</label>
                <select id="packLevel" class="cell-input">
                  <option value="essentiel">Essentiel</option>
                  <option value="standard" selected>Standard</option>
                  <option value="premium">Premium</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button id="btnLoadPack" class="good">Charger le pack (remplacer)</button>
              <button id="btnAppendPack" class="ghost">Ajouter le pack (garder lignes)</button>
              <button id="btnReset" class="danger">Réinitialiser</button>
            </div>
            <div class="tiny" style="margin-top:8px">
              En mode “marge-cible”, le PU est verrouillé si un coût interne est renseigné.
            </div>
          </div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button id="btnPrint" class="ghost">Imprimer / PDF</button>
          <button id="btnExportJson" class="ghost">Exporter JSON</button>
          <button id="btnImportJson" class="ghost">Importer JSON</button>
          <input id="jsonFile" type="file" accept="application/json" style="display:none" />
        </div>

        <div style="margin-top:12px">
          <label>Notes / conditions (optionnel)</label>
          <textarea id="notes" class="cell-input" placeholder="Délais, conditions de paiement, droits, etc."></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <strong>Prestations & matériel</strong>
        <span class="pill">HT + marge + TVA calculés</span>
      </div>
      <div class="bd">
        <div class="split">
          <div>
            <div class="pill" style="margin-bottom:10px">1) Services</div>
            <div class="tablewrap">
              <table id="servicesTable">
                <thead>
                  <tr>
                    <th>Intitulé</th>
                    <th>Description</th>
                    <th class="col-unit">Unité</th>
                    <th class="right col-qty">Qté</th>
                    <th class="right col-price">PU vente</th>
                    <th class="right col-cost">Coût interne</th>
                    <th class="right col-total">Total</th>
                    <th class="center col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="btns" style="margin-top:10px">
              <button id="btnAddService">+ Ligne service</button>
            </div>
          </div>

          <div>
            <div class="pill" style="margin-bottom:10px">2) Matériel (loc / jour)</div>
            <div class="tablewrap">
              <table id="gearTable">
                <thead>
                  <tr>
                    <th>Matériel</th>
                    <th class="right col-qty">Qté</th>
                    <th class="right col-qty">Jours</th>
                    <th class="right col-price">PU / jour</th>
                    <th class="right col-cost">Coût / jour (estim.)</th>
                    <th class="right col-total">Total</th>
                    <th class="center col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="btns" style="margin-top:10px">
              <button id="btnAddGear">+ Ligne matériel</button>
            </div>
            <div class="tiny" style="margin-top:6px">
              Coût matériel estimé = (prix d’achat / amortissement) sinon fallback = % du PU.
            </div>
          </div>
        </div>

        <div class="totals" id="totalsBlock"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Données intégrées ===== */
const INVENTORY = [{"name": "Flightcase long — Thon — Thon XL-Plus Accessories Case", "category": "Accessoires", "type": "Flightcase long", "brand": "Thon", "model": "Thon XL-Plus Accessories Case", "dayRate": 0.0, "purchasePrice": 333.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Flightcase tool — Thon — Thon Drawercase L1205/A", "category": "Accessoires", "type": "Flightcase tool", "brand": "Thon", "model": "Thon Drawercase L1205/A", "dayRate": 0.0, "purchasePrice": 1329.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Flightcase panière — Tool — Thon Accessory Case 2x3 Boxes PB", "category": "Accessoires", "type": "Flightcase panière", "brand": "Tool", "model": "Thon Accessory Case 2x3 Boxes PB", "dayRate": 0.0, "purchasePrice": 989.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Câble HDMI 5m — Divers — HDMI Premium", "category": "Câbles", "type": "Câble HDMI 5m", "brand": "Divers", "model": "HDMI Premium", "dayRate": 5.0, "purchasePrice": 15.0, "quantity": 10.0, "source": "Somegec"}, {"name": "Câble SDI 5m — Divers — SDI 12G", "category": "Câbles", "type": "Câble SDI 5m", "brand": "Divers", "model": "SDI 12G", "dayRate": 6.0, "purchasePrice": 40.0, "quantity": 30.0, "source": "Somegec"}, {"name": "Câble XLR 10m — Divers — XLR", "category": "Câbles", "type": "Câble XLR 10m", "brand": "Divers", "model": "XLR", "dayRate": 2.5, "purchasePrice": 20.0, "quantity": 30.0, "source": "Somegec"}, {"name": "Câble XLR 20m — Divers — XLR", "category": "Câbles", "type": "Câble XLR 20m", "brand": "Divers", "model": "XLR", "dayRate": 3.0, "purchasePrice": 30.0, "quantity": 5.0, "source": "Somegec"}, {"name": "Câble XLR 5m — Divers — XLR", "category": "Câbles", "type": "Câble XLR 5m", "brand": "Divers", "model": "XLR", "dayRate": 2.0, "purchasePrice": 15.0, "quantity": 5.0, "source": "Somegec"}, {"name": "Touret combo — Divers — 3G-SDI + RJ45 type 7 – 50m", "category": "Câbles", "type": "Touret combo", "brand": "Divers", "model": "3G-SDI + RJ45 type 7 – 50m", "dayRate": 40.0, "purchasePrice": 400.0, "quantity": 10.0, "source": "Somegec"}, {"name": "Touret HDMI — Divers — HDMI fibre 50m", "category": "Câbles", "type": "Touret HDMI", "brand": "Divers", "model": "HDMI fibre 50m", "dayRate": 17.0, "purchasePrice": 300.0, "quantity": 3.0, "source": "Somegec"}, {"name": "Touret RJ45 — Divers — RJ45 prise ronde (50m)", "category": "Câbles", "type": "Touret RJ45", "brand": "Divers", "model": "RJ45 prise ronde (50m)", "dayRate": 23.0, "purchasePrice": 150.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Touret SDI — Divers — HD-SDI 50m", "category": "Câbles", "type": "Touret SDI", "brand": "Divers", "model": "HD-SDI 50m", "dayRate": 18.0, "purchasePrice": 250.0, "quantity": 3.0, "source": "Somegec"}, {"name": "Caméra — Blackmagic — URSA Broadcast G2", "category": "Caméras", "type": "Caméra", "brand": "Blackmagic", "model": "URSA Broadcast G2", "dayRate": 170.0, "purchasePrice": 5100.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Caméra PTZ — Panasonic — AW-UE145", "category": "Caméras", "type": "Caméra PTZ", "brand": "Panasonic", "model": "AW-UE145", "dayRate": 240.0, "purchasePrice": 6600.0, "quantity": 3.0, "source": "Somegec"}, {"name": "Pied caméra avec embase — - — Pied + embase noire", "category": "Caméras", "type": "Pied caméra avec embase", "brand": "-", "model": "Pied + embase noire", "dayRate": 15.0, "purchasePrice": 150.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Transmission vidéo — Hollyland — Cosmo C1", "category": "Caméras", "type": "Transmission vidéo", "brand": "Hollyland", "model": "Cosmo C1", "dayRate": 33.0, "purchasePrice": 900.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Transmission vidéo — Hollyland — C600", "category": "Caméras", "type": "Transmission vidéo", "brand": "Hollyland", "model": "C600", "dayRate": 45.0, "purchasePrice": 600.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Écran — Panasonic — 75\" + pied", "category": "Écrans", "type": "Écran", "brand": "Panasonic", "model": "75\" + pied", "dayRate": 370.0, "purchasePrice": 2500.0, "quantity": 3.0, "source": "Somegec"}, {"name": "Pied lumière — - — Pied lumière standard", "category": "Lumière", "type": "Pied lumière", "brand": "-", "model": "Pied lumière standard", "dayRate": 8.0, "purchasePrice": 50.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Projecteur LED — Nanlite — Forza 60B kit + softbox", "category": "Lumière", "type": "Projecteur LED", "brand": "Nanlite", "model": "Forza 60B kit + softbox", "dayRate": 20.0, "purchasePrice": 350.0, "quantity": 4.0, "source": "Somegec"}, {"name": "Projecteur LED — Nanlite — Forza FS 300", "category": "Lumière", "type": "Projecteur LED", "brand": "Nanlite", "model": "Forza FS 300", "dayRate": 40.0, "purchasePrice": 500.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Moniteur rack — Lilliput — BM280 4K", "category": "Régie", "type": "Moniteur rack", "brand": "Lilliput", "model": "BM280 4K", "dayRate": 45.0, "purchasePrice": 1700.0, "quantity": 3.0, "source": "Somegec"}, {"name": "Moniteur vision — Blackmagic — SmartView 4K (20\")", "category": "Régie", "type": "Moniteur vision", "brand": "Blackmagic", "model": "SmartView 4K (20\")", "dayRate": 31.0, "purchasePrice": 900.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Carte son — Focusrite — 16 IN / 8 OUT", "category": "Régie", "type": "Carte son", "brand": "Focusrite", "model": "16 IN / 8 OUT", "dayRate": 47.0, "purchasePrice": 1000.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Contrôleur MIDI — Divers — MIDI panel vMix", "category": "Régie", "type": "Contrôleur MIDI", "brand": "Divers", "model": "MIDI panel vMix", "dayRate": 22.0, "purchasePrice": 200.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Contrôleur PTZ — Panasonic — AW-RP150G", "category": "Régie", "type": "Contrôleur PTZ", "brand": "Panasonic", "model": "AW-RP150G", "dayRate": 140.0, "purchasePrice": 4500.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Convertisseur vidéo — Blackmagic — SDI-HDMI bidirectional", "category": "Régie", "type": "Convertisseur vidéo", "brand": "Blackmagic", "model": "SDI-HDMI bidirectional", "dayRate": 20.0, "purchasePrice": 65.0, "quantity": 10.0, "source": "Somegec"}, {"name": "Enregistreur — Blackmagic — HyperDeck Studio", "category": "Régie", "type": "Enregistreur", "brand": "Blackmagic", "model": "HyperDeck Studio", "dayRate": 75.0, "purchasePrice": 800.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Intercom — Vokkero — 6 postes", "category": "Régie", "type": "Intercom", "brand": "Vokkero", "model": "6 postes", "dayRate": 65.0, "purchasePrice": 600.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Matrice vidéo — Blackmagic — Smart Videohub 8x8", "category": "Régie", "type": "Matrice vidéo", "brand": "Blackmagic", "model": "Smart Videohub 8x8", "dayRate": 45.0, "purchasePrice": 1000.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Mélangeur vidéo — Blackmagic — ATEM Television Studio HD8 ISO", "category": "Régie", "type": "Mélangeur vidéo", "brand": "Blackmagic", "model": "ATEM Television Studio HD8 ISO", "dayRate": 300.0, "purchasePrice": 4000.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Régie PC vMix — Custom/vMix — 8 entrées SDI + 2 sorties SDI + 1 HDMI", "category": "Régie", "type": "Régie PC vMix", "brand": "Custom/vMix", "model": "8 entrées SDI + 2 sorties SDI + 1 HDMI", "dayRate": 500.0, "purchasePrice": 6000.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Moniteurs — Blackmagic — SmartView Duo", "category": "Régie", "type": "Moniteurs", "brand": "Blackmagic", "model": "SmartView Duo", "dayRate": 21.0, "purchasePrice": 489.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Routeur réseau — Divers — 16 ports dont 8 PoE", "category": "Régie", "type": "Routeur réseau", "brand": "Divers", "model": "16 ports dont 8 PoE", "dayRate": 69.0, "purchasePrice": 300.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Enregistreur — Blackmagic — HyperDeck Studio HD Mini", "category": "Régie", "type": "Enregistreur", "brand": "Blackmagic", "model": "HyperDeck Studio HD Mini", "dayRate": 60.0, "purchasePrice": 455.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Talkback — Sonifex — CM-CU1", "category": "Régie", "type": "Talkback", "brand": "Sonifex", "model": "CM-CU1", "dayRate": 68.0, "purchasePrice": 2260.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Console audio — Yamaha — DM3", "category": "Son", "type": "Console audio", "brand": "Yamaha", "model": "DM3", "dayRate": 125.0, "purchasePrice": 1500.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Enceinte + Sub — Bose — F1 + Sub", "category": "Son", "type": "Enceinte + Sub", "brand": "Bose", "model": "F1 + Sub", "dayRate": 140.0, "purchasePrice": 2000.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Enceinte monitoring — Genelec — 8020", "category": "Son", "type": "Enceinte monitoring", "brand": "Genelec", "model": "8020", "dayRate": 20.0, "purchasePrice": 400.0, "quantity": 4.0, "source": "Somegec"}, {"name": "Enceinte portable — Bose — S1 Pro", "category": "Son", "type": "Enceinte portable", "brand": "Bose", "model": "S1 Pro", "dayRate": 30.0, "purchasePrice": 600.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Micro HF — Sennheiser — 6000 + capsule Neumann", "category": "Son", "type": "Micro HF", "brand": "Sennheiser", "model": "6000 + capsule Neumann", "dayRate": 90.0, "purchasePrice": 3000.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Pied micro — K&M — Standard", "category": "Son", "type": "Pied micro", "brand": "K&M", "model": "Standard", "dayRate": 7.0, "purchasePrice": 60.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Pieds enceintes — - — Pieds + embases noirs", "category": "Son", "type": "Pieds enceintes", "brand": "-", "model": "Pieds + embases noirs", "dayRate": 8.0, "purchasePrice": 100.0, "quantity": 2.0, "source": "Somegec"}, {"name": "Récepteur HF — Sennheiser — EM 6000", "category": "Son", "type": "Récepteur HF", "brand": "Sennheiser", "model": "EM 6000", "dayRate": 80.0, "purchasePrice": 2500.0, "quantity": 6.0, "source": "Somegec"}, {"name": "Stagebox — Yamaha — Tio", "category": "Son", "type": "Stagebox", "brand": "Yamaha", "model": "Tio", "dayRate": 40.0, "purchasePrice": 1000.0, "quantity": 1.0, "source": "Somegec"}, {"name": "Caméra — Sony — FX6", "category": "Caméra", "type": "Caméra", "brand": "Sony", "model": "FX6", "dayRate": 160.0, "purchasePrice": 5950.8, "quantity": 1.0, "source": "Lyon"}, {"name": "Follow focus — Tilta — Nucleus M Wireless Lens Control Full Kit", "category": "Caméra", "type": "Follow focus", "brand": "Tilta", "model": "Nucleus M Wireless Lens Control Full Kit", "dayRate": 180.0, "purchasePrice": 1558.8, "quantity": 1.0, "source": "Lyon"}, {"name": "Gimbal — DJI — Ronin RS4 Pro Combo", "category": "Caméra", "type": "Gimbal", "brand": "DJI", "model": "Ronin RS4 Pro Combo", "dayRate": 54.0, "purchasePrice": 1099.0, "quantity": 1.0, "source": "Lyon"}, {"name": "Objectif — Sony — FE 28-70mm F2 GM", "category": "Caméra", "type": "Objectif", "brand": "Sony", "model": "FE 28-70mm F2 GM", "dayRate": 89.0, "purchasePrice": 3500.0, "quantity": 1.0, "source": "Lyon"}, {"name": "Trépied — Manfrotto — Nitrotech 608 + twin leg carbon", "category": "Caméra", "type": "Trépied", "brand": "Manfrotto", "model": "Nitrotech 608 + twin leg carbon", "dayRate": 35.0, "purchasePrice": 1003.2, "quantity": 1.0, "source": "Lyon"}, {"name": "Objectif — Irix — Irix Cine Directors Set Sony E Metric", "category": "Caméra", "type": "Objectif", "brand": "Irix", "model": "Irix Cine Directors Set Sony E Metric", "dayRate": 350.0, "purchasePrice": 8160.98, "quantity": 1.0, "source": "Lyon"}, {"name": "Carte son — Focusrite — Scarlett 2i2 4th Gen", "category": "Studio", "type": "Carte son", "brand": "Focusrite", "model": "Scarlett 2i2 4th Gen", "dayRate": 0.0, "purchasePrice": 179.0, "quantity": 1.0, "source": "Lyon"}, {"name": "Ordinateur — Apple — MacBook Pro M4 Max", "category": "Studio", "type": "Ordinateur", "brand": "Apple", "model": "MacBook Pro M4 Max", "dayRate": 0.0, "purchasePrice": 5549.0, "quantity": 1.0, "source": "Lyon"}];
const ROLE_RATES = [{"role": "Recherche", "rate": 50.0}, {"role": "Script/Storyboard", "rate": 50.0}, {"role": "Organisation", "rate": 50.0}, {"role": "Ideation", "rate": 50.0}, {"role": "Réalisateur", "rate": 91.5}, {"role": "Chef opérateur", "rate": 82.8}, {"role": "Cadreur", "rate": 36.5}, {"role": "Chef électricien", "rate": 38.2}, {"role": "Technicien vidéo", "rate": 39.0}, {"role": "Ingénieur du son", "rate": 37.0}, {"role": "Assistant son", "rate": 35.1}, {"role": "Monteur vision (switcher)", "rate": 37.6}, {"role": "Maquillage", "rate": 40.0}, {"role": "Chef monteur", "rate": 39.0}, {"role": "Étalonneur", "rate": 37.2}, {"role": "Monteur son", "rate": 36.5}, {"role": "Assistant monteur", "rate": 35.3}, {"role": "Graphiste habillages", "rate": 37.2}, {"role": "Présentateur/Journaliste", "rate": 3000.0}];
const KEYMAP = {"FX6": 45, "FE 28-70mm": 48, "Nitrotech": 49, "Ronin RS4 Pro": 47, "RS 4 Pro": 47, "Nucleus": 46, "Forza 60B": 19, "Forza FS 300": 20, "Irix": 50, "Irix Cine": 50, "Pied lumière standard": 18, "ATEM": 30, "HyperDeck Studio": 27, "HyperDeck Studio HD Mini": 34, "Smart Videohub": 29, "SmartView 4K": 22, "SmartView Duo": 32, "Routeur réseau": 33, "Talkback": 35, "Intercom": 28, "AW-UE145": 13, "AW-RP150G": 25, "DM3": 36, "Tio": 44, "Micro HF": 40, "Récepteur HF": 43, "Pied micro": 41, "Touret combo": 8, "Touret SDI": 11, "Touret RJ45": 10, "Touret HDMI": 9, "Régie PC vMix": 31, "vMix": 24, "75\" + pied": 17, "Pied + embase noire": 14, "URSA Broadcast G2": 12, "URSA": 12, "Transmission vidéo": 15, "Moniteur rack": 21, "Carte son": 23};

/* ===== État ===== */
const state = {
  meta: { quoteNumber:"", quoteDate:"", issuerName:"Momentum Creative Productions (MCP)",
          vatRegime:"Assujetti TVA — Régime simplifié", clientName:"", clientContact:"",
          projectName:"", projectPlace:"", notes:"" },
  pricing: { mode:"margin", targetMargin:0.50, vatRate:0.20 },
  gearCost: { amortDays:120, fallbackShare:0.40 },
  prefs: { prefillPU:true },
  services: [],
  gear: []
};

/* ===== Helpers ===== */
const € = (n) => (isFinite(n) ? n.toFixed(2) + " €" : "—");
const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
const num = (v, fallback=0) => {
  const x = Number(v);
  return Number.isFinite(x) ? x : fallback;
};

function roleRate(roleName){
  const r = ROLE_RATES.find(x => x.role === roleName);
  return r ? Number(r.rate) : 0;
}
function costFromRoles(hoursMap){
  let total = 0;
  for (const [role, h] of Object.entries(hoursMap)){
    total += roleRate(role) * Number(h);
  }
  return total;
}
function suggestedPU(costUnit){
  const m = clamp(state.pricing.targetMargin, 0, 0.95);
  if (!isFinite(costUnit) || costUnit <= 0) return 0;
  return costUnit / (1 - m);
}
function gearCostPerDay(invItem){
  const amort = Math.max(10, num(state.gearCost.amortDays, 120));
  if (invItem && invItem.purchasePrice && isFinite(invItem.purchasePrice) && invItem.purchasePrice > 0){
    return invItem.purchasePrice / amort;
  }
  const fallback = clamp(num(state.gearCost.fallbackShare, 0.4), 0, 1);
  return (invItem ? invItem.dayRate : 0) * fallback;
}
function invFind(keyword){
  if (KEYMAP[keyword] !== undefined) return KEYMAP[keyword];
  const k = (keyword || "").toLowerCase();
  if (!k) return -1;
  // fallback: normalized contains
  const norm = (s)=>String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"");
  const nk = norm(keyword);
  let best = {i:-1, sc:0};
  for (let i=0;i<INVENTORY.length;i++){
    const it = INVENTORY[i];
    const name = it.name || "";
    const model = it.model || "";
    let sc = 0;
    if ((model||"").toLowerCase() === k) sc = 120;
    else if (new RegExp("\\\\b"+keyword.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+"\\\\b","i").test(model)) sc = 100;
    else if (nk && norm(name).includes(nk)) sc = 70;
    else if ((name||"").toLowerCase().includes(k)) sc = 50;
    if (sc>best.sc){ best={i,sc}; }
  }
  return best.sc>=60 ? best.i : -1;
}

function addServiceLine({name, desc="", unit="jour", qty=1, costUnit=0, unitPrice=0}){
  state.services.push({
    name, desc, unit,
    qty: num(qty,1),
    costUnit: num(costUnit,0),
    unitPrice: num(unitPrice,0)
  });
}
function addGearLine({invIndex=0, qty=1, days=1, unitPrice=null, costPerDay=null}){
  const it = INVENTORY[invIndex] || null;
  const pu = (unitPrice === null) ? (it ? it.dayRate : 0) : unitPrice;
  const cpd = (costPerDay === null) ? (it ? gearCostPerDay(it) : 0) : costPerDay;

  state.gear.push({
    invIndex,
    qty: num(qty,1),
    days: num(days,1),
    unitPrice: num(pu,0),
    costPerDay: num(cpd,0),
    unitAuto: unitPrice === null,
    costAuto: costPerDay === null
  });
}
function addGearByKeyword(keyword, qty, days){
  const idx = invFind(keyword);
  if (idx >= 0) addGearLine({invIndex: idx, qty, days});
  else console.warn("Matériel introuvable:", keyword);
}

/* ===== Packs (coûts basés sur ton calculateur) ===== */
const COST = {
  preprodDay: () => costFromRoles({"Organisation":6, "Script/Storyboard":2}),
  shootDayLight: () => costFromRoles({"Chef opérateur":8, "Ingénieur du son":4, "Chef électricien":4}),
  eventShootDay: () => costFromRoles({"Cadreur":8, "Ingénieur du son":2}),
  liveDay: () => costFromRoles({"Réalisateur":8, "Monteur vision (switcher)":8, "Technicien vidéo":8, "Ingénieur du son":8}),
  editDay: () => costFromRoles({"Chef monteur":8, "Assistant monteur":2}),
  colorHalfDay: () => costFromRoles({"Étalonneur":4}),
  soundHalfDay: () => costFromRoles({"Monteur son":4}),
  motionHalfDay: () => costFromRoles({"Graphiste habillages":4}),
  deliveryForfait: () => costFromRoles({"Assistant monteur":1})
};

const PACKS = {
  film: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Cadrage, préparation, script léger", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"1 journée — équipe légère", unit:"jour", qty:1, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Sélection + montage + exports", unit:"jour", qty:2, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports + livraison + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 1);
      addGearByKeyword("FE 28-70mm", 1, 1);
      addGearByKeyword("Nitrotech", 1, 1);
      addGearByKeyword("Forza 60B", 2, 1);
      addGearByKeyword("Pied lumière standard", 4, 1);
    },
    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Cadrage, repérage léger, script", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"1,5 journée — interviews + plans d’illustration", unit:"jour", qty:1.5, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Montage + versions + exports", unit:"jour", qty:3, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Cohérence colorimétrique", unit:"jour", qty:0.5, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Montage son / mix", desc:"Nettoyage, équilibre, export", unit:"jour", qty:0.5, costUnit:COST.soundHalfDay()});
      addServiceLine({name:"Habillage léger", desc:"Titres, lower thirds simples", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports + livraison + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 1);
      addGearByKeyword("Nucleus", 1, 1);
      addGearByKeyword("Forza 60B", 2, 2);
      addGearByKeyword("Forza FS 300", 1, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    },
    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Cadrage complet, script, planning, repérage", unit:"jour", qty:3, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage", desc:"3 journées — interviews + b-roll avancé", unit:"jour", qty:3, costUnit:COST.shootDayLight()});
      addServiceLine({name:"Montage", desc:"Montage avancé + itérations", unit:"jour", qty:6, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Color grading", unit:"jour", qty:1, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Montage son / mix", desc:"Nettoyage + mix", unit:"jour", qty:1, costUnit:COST.soundHalfDay()});
      addServiceLine({name:"Habillage", desc:"Titres + animations simples", unit:"jour", qty:1, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports / archivage", desc:"Exports multi-formats + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 3);
      addGearByKeyword("FE 28-70mm", 1, 3);
      addGearByKeyword("Irix", 1, 2);
      addGearByKeyword("Nitrotech", 1, 3);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("Nucleus", 1, 2);
      addGearByKeyword("Forza 60B", 4, 3);
      addGearByKeyword("Forza FS 300", 1, 3);
      addGearByKeyword("Pied lumière standard", 6, 3);
    }
  },

  aftermovie: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Brief + organisation", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"Couverture 1 journée", unit:"jour", qty:1, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie 60–120s", unit:"jour", qty:1.5, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 1);
      addGearByKeyword("Ronin RS4 Pro", 1, 1);
      addGearByKeyword("FE 28-70mm", 1, 1);
      addGearByKeyword("Nitrotech", 1, 1);
      addGearByKeyword("Forza 60B", 2, 1);
      addGearByKeyword("Pied lumière standard", 4, 1);
    },
    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Brief + déroulé + plan de tournage", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"1 à 2 journées", unit:"jour", qty:1.5, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie + cutdowns réseaux", unit:"jour", qty:2.5, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Cohérence look", unit:"jour", qty:0.5, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Forza 60B", 2, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    },
    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Pré-production", desc:"Organisation + script + coordination", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Tournage événement", desc:"2 journées", unit:"jour", qty:2, costUnit:COST.eventShootDay()});
      addServiceLine({name:"Montage", desc:"Aftermovie + versions multiples + itérations", unit:"jour", qty:4, costUnit:COST.editDay()});
      addServiceLine({name:"Étalonnage", desc:"Look final", unit:"jour", qty:1, costUnit:COST.colorHalfDay()});
      addServiceLine({name:"Habillage", desc:"Titres + animations", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / exports", desc:"Exports multi-formats", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("FX6", 1, 2);
      addGearByKeyword("Ronin RS4 Pro", 1, 2);
      addGearByKeyword("FE 28-70mm", 1, 2);
      addGearByKeyword("Irix", 1, 1);
      addGearByKeyword("Nitrotech", 1, 2);
      addGearByKeyword("Forza 60B", 4, 2);
      addGearByKeyword("Forza FS 300", 1, 2);
      addGearByKeyword("Pied lumière standard", 6, 2);
    }
  },

  live_teams: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Préparation live", desc:"Brief + plan technique + tests", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée — table ronde / Q&R", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Livraison replay", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("AW-UE145", 2, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 2, 1);
      addGearByKeyword("Récepteur HF", 2, 1);
      addGearByKeyword("Pied micro", 2, 1);
      addGearByKeyword("Touret combo", 1, 1);
      addGearByKeyword("Touret SDI", 1, 1);
      addGearByKeyword("Touret RJ45", 1, 1);
    },
    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Préparation live", desc:"Brief + conduite + tests + répétition", unit:"jour", qty:1, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage léger replay", desc:"Nettoyage début/fin + export", unit:"jour", qty:0.5, costUnit:COST.editDay()});
      addServiceLine({name:"Livraison replay", desc:"Exports + livraison", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 4, 1);
      addGearByKeyword("Récepteur HF", 4, 1);
      addGearByKeyword("Pied micro", 4, 1);
      addGearByKeyword("Touret combo", 1, 1);
      addGearByKeyword("Touret SDI", 2, 1);
      addGearByKeyword("Touret RJ45", 1, 1);
    },
    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Préparation live", desc:"Plan technique + conduite + répétitions", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Nettoyage + chapitrage léger", unit:"jour", qty:1, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage live", desc:"Lower thirds + visuels simples", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison", desc:"Exports + livraison + archivage", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});
      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 6, 1);
      addGearByKeyword("Récepteur HF", 6, 1);
      addGearByKeyword("Pied micro", 6, 1);
      addGearByKeyword("75\" + pied", 1, 1);
      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 2, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
    }
  },

  live_talkshow: {
    essentiel: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      PACKS.live_teams.standard(true);
      addServiceLine({name:"Cadrage plateau / répétition", desc:"Brief plateau + répétition", unit:"jour", qty:0.5, costUnit:COST.preprodDay()});
      addGearByKeyword("Moniteur rack", 1, 1);
      addGearByKeyword("Carte son", 1, 1);
    },
    standard: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Préparation talk-show", desc:"Conduite + plan plateau + répétition", unit:"jour", qty:1.5, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée — talk-show", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Nettoyage + export + versions", unit:"jour", qty:1, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage", desc:"Titres + lower thirds", unit:"jour", qty:0.5, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / archivage", desc:"Exports + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);

      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("Pied + embase noire", 3, 1);

      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 4, 1);
      addGearByKeyword("Récepteur HF", 4, 1);
      addGearByKeyword("Pied micro", 4, 1);

      addGearByKeyword("75\" + pied", 1, 1);

      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 3, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
    },
    premium: (append=false) => {
      if (!append) { state.services=[]; state.gear=[]; }
      addServiceLine({name:"Préparation talk-show", desc:"Cadrage + conduite + répétitions + habillages", unit:"jour", qty:2, costUnit:COST.preprodDay()});
      addServiceLine({name:"Exploitation live", desc:"1 journée", unit:"jour", qty:1, costUnit:COST.liveDay()});
      addServiceLine({name:"Montage replay", desc:"Replay + chapitrage + cutdowns", unit:"jour", qty:2, costUnit:COST.editDay()});
      addServiceLine({name:"Habillage", desc:"Pack titres + lower thirds + animations simples", unit:"jour", qty:1, costUnit:COST.motionHalfDay()});
      addServiceLine({name:"Livraison / archivage", desc:"Exports multi-formats + sauvegardes", unit:"forfait", qty:1, costUnit:COST.deliveryForfait()});

      addGearByKeyword("Régie PC vMix", 1, 1);
      addGearByKeyword("ATEM", 1, 1);
      addGearByKeyword("Smart Videohub", 1, 1);
      addGearByKeyword("SmartView 4K", 1, 1);
      addGearByKeyword("SmartView Duo", 1, 1);
      addGearByKeyword("Routeur réseau", 1, 1);
      addGearByKeyword("Talkback", 1, 1);
      addGearByKeyword("Intercom", 1, 1);
      addGearByKeyword("HyperDeck Studio", 1, 1);
      addGearByKeyword("HyperDeck Studio HD Mini", 1, 1);

      addGearByKeyword("AW-UE145", 3, 1);
      addGearByKeyword("AW-RP150G", 1, 1);
      addGearByKeyword("URSA Broadcast G2", 1, 1);
      addGearByKeyword("Transmission vidéo", 2, 1);
      addGearByKeyword("Pied + embase noire", 4, 1);

      addGearByKeyword("DM3", 1, 1);
      addGearByKeyword("Tio", 1, 1);
      addGearByKeyword("Micro HF", 6, 1);
      addGearByKeyword("Récepteur HF", 6, 1);
      addGearByKeyword("Pied micro", 6, 1);
      addGearByKeyword("75\" + pied", 1, 1);

      addGearByKeyword("Touret combo", 2, 1);
      addGearByKeyword("Touret SDI", 4, 1);
      addGearByKeyword("Touret RJ45", 2, 1);
      addGearByKeyword("Touret HDMI", 1, 1);
    }
  }
};

/* ===== UI ===== */
const els = {
  quoteNumber: document.getElementById("quoteNumber"),
  quoteDate: document.getElementById("quoteDate"),
  issuerName: document.getElementById("issuerName"),
  vatRegime: document.getElementById("vatRegime"),
  clientName: document.getElementById("clientName"),
  clientContact: document.getElementById("clientContact"),
  projectName: document.getElementById("projectName"),
  projectPlace: document.getElementById("projectPlace"),
  notes: document.getElementById("notes"),
  pricingMode: document.getElementById("pricingMode"),
  targetMargin: document.getElementById("targetMargin"),
  vatRate: document.getElementById("vatRate"),
  amortDays: document.getElementById("amortDays"),
  fallbackGearCostShare: document.getElementById("fallbackGearCostShare"),
  prefillPU: document.getElementById("prefillPU"),
  packType: document.getElementById("packType"),
  packLevel: document.getElementById("packLevel"),
  pillVat: document.getElementById("pillVat"),
  pillMargin: document.getElementById("pillMargin"),
  servicesBody: document.querySelector("#servicesTable tbody"),
  gearBody: document.querySelector("#gearTable tbody"),
  totalsBlock: document.getElementById("totalsBlock"),
  btnAddService: document.getElementById("btnAddService"),
  btnAddGear: document.getElementById("btnAddGear"),
  btnLoadPack: document.getElementById("btnLoadPack"),
  btnAppendPack: document.getElementById("btnAppendPack"),
  btnReset: document.getElementById("btnReset"),
  btnPrint: document.getElementById("btnPrint"),
  btnExportJson: document.getElementById("btnExportJson"),
  btnImportJson: document.getElementById("btnImportJson"),
  jsonFile: document.getElementById("jsonFile"),
};

function syncControls(){
  state.pricing.mode = els.pricingMode.value;
  state.pricing.targetMargin = clamp(num(els.targetMargin.value, 0.5), 0, 0.95);
  state.pricing.vatRate = clamp(num(els.vatRate.value, 0.2), 0, 1);
  state.gearCost.amortDays = Math.max(10, Math.floor(num(els.amortDays.value, 120)));
  state.gearCost.fallbackShare = clamp(num(els.fallbackGearCostShare.value, 0.4), 0, 1);
  state.prefs.prefillPU = (els.prefillPU.value === "yes");
  els.pillVat.textContent = Math.round(state.pricing.vatRate*100) + "%";
  els.pillMargin.textContent = Math.round(state.pricing.targetMargin*100) + "%";
}

/* ===== Rendering (stable + recalculs fiables) ===== */
function makeInput(value, type="text"){
  const i = document.createElement("input");
  i.className = "cell-input";
  i.type = type;
  i.value = value ?? "";
  return i;
}
function makeSelect(options, value){
  const s = document.createElement("select");
  s.className = "cell-input";
  for (const opt of options){
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    if (opt.value === value) o.selected = true;
    s.appendChild(o);
  }
  return s;
}
function iconBtn(text, cls, onClick){
  const b = document.createElement("button");
  b.textContent = text;
  b.className = cls;
  b.style.minHeight = "40px";
  b.style.padding = "10px 12px";
  b.addEventListener("click", onClick);
  return b;
}

function serviceUnitPrice(line){
  if (state.pricing.mode === "margin" && num(line.costUnit,0) > 0){
    return suggestedPU(num(line.costUnit,0));
  }
  return num(line.unitPrice,0);
}
function serviceLineTotal(line){
  return num(line.qty,0) * serviceUnitPrice(line);
}
function serviceLineCost(line){
  return num(line.qty,0) * num(line.costUnit,0);
}
function gearLineTotal(g){
  return num(g.qty,0) * num(g.days,0) * num(g.unitPrice,0);
}
function gearLineCost(g){
  return num(g.qty,0) * num(g.days,0) * num(g.costPerDay,0);
}

function renderTables(){
  syncControls();

  /* Services */
  els.servicesBody.innerHTML = "";
  state.services.forEach((line, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.index = idx;

    const tdName = document.createElement("td");
    const iName = makeInput(line.name, "text");
    iName.addEventListener("input", () => { line.name = iName.value; });
    tdName.appendChild(iName); tr.appendChild(tdName);

    const tdDesc = document.createElement("td");
    const iDesc = makeInput(line.desc, "text");
    iDesc.addEventListener("input", () => { line.desc = iDesc.value; });
    tdDesc.appendChild(iDesc); tr.appendChild(tdDesc);

    const tdUnit = document.createElement("td"); tdUnit.className="col-unit";
    const sUnit = makeSelect([
      {value:"jour", label:"jour"},
      {value:"h", label:"h"},
      {value:"forfait", label:"forfait"},
    ], line.unit);
    sUnit.addEventListener("change", () => { line.unit = sUnit.value; });
    tdUnit.appendChild(sUnit); tr.appendChild(tdUnit);

    const tdQty = document.createElement("td"); tdQty.className="right col-qty";
    const iQty = makeInput(line.qty, "number"); iQty.step="0.25"; iQty.min="0";
    iQty.addEventListener("input", () => { line.qty = num(iQty.value,0); refreshComputed(); });
    tdQty.appendChild(iQty); tr.appendChild(tdQty);

    const tdPU = document.createElement("td"); tdPU.className="right col-price";
    const iPU = makeInput(serviceUnitPrice(line), "number"); iPU.step="1"; iPU.min="0";
    iPU.addEventListener("input", () => { line.unitPrice = num(iPU.value,0); refreshComputed(); });
    tdPU.appendChild(iPU); tr.appendChild(tdPU);

    const tdCost = document.createElement("td"); tdCost.className="right col-cost";
    const iCost = makeInput(line.costUnit, "number"); iCost.step="1"; iCost.min="0";
    iCost.addEventListener("input", () => { line.costUnit = num(iCost.value,0); refreshComputed(); });
    tdCost.appendChild(iCost); tr.appendChild(tdCost);

    const tdTot = document.createElement("td"); tdTot.className="right col-total";
    tdTot.classList.add("line-total");
    tdTot.textContent = €(serviceLineTotal(line));
    tr.appendChild(tdTot);

    const tdAct = document.createElement("td"); tdAct.className="center col-actions";
    tdAct.appendChild(iconBtn("Suppr.", "danger", () => { state.services.splice(idx,1); renderTables(); refreshComputed(); }));
    tr.appendChild(tdAct);

    els.servicesBody.appendChild(tr);
  });

  /* Gear */
  els.gearBody.innerHTML = "";
  state.gear.forEach((g, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.index = idx;

    const tdItem = document.createElement("td");
    const s = document.createElement("select");
    s.className="cell-input";
    INVENTORY.forEach((it,i) => {
      const o=document.createElement("option");
      o.value=String(i);
      o.textContent = `${it.name} — ${Number(it.dayRate||0).toFixed(2)}€/j (${it.source})`;
      if (i===g.invIndex) o.selected=true;
      s.appendChild(o);
    });
    s.addEventListener("change", () => {
      g.invIndex = Number(s.value);
      const it = INVENTORY[g.invIndex];
      g.unitPrice = it.dayRate;
      g.costPerDay = gearCostPerDay(it);
      g.unitAuto = true;
      g.costAuto = true;
      renderTables();
      refreshComputed();
    });
    tdItem.appendChild(s); tr.appendChild(tdItem);

    const tdQty = document.createElement("td"); tdQty.className="right col-qty";
    const iQty = makeInput(g.qty,"number"); iQty.step="1"; iQty.min="0";
    iQty.addEventListener("input", ()=>{ g.qty=num(iQty.value,0); refreshComputed(); });
    tdQty.appendChild(iQty); tr.appendChild(tdQty);

    const tdDays = document.createElement("td"); tdDays.className="right col-qty";
    const iDays = makeInput(g.days,"number"); iDays.step="0.5"; iDays.min="0";
    iDays.addEventListener("input", ()=>{ g.days=num(iDays.value,0); refreshComputed(); });
    tdDays.appendChild(iDays); tr.appendChild(tdDays);

    const tdPU = document.createElement("td"); tdPU.className="right col-price";
    const iPU = makeInput(g.unitPrice,"number"); iPU.step="1"; iPU.min="0";
    iPU.addEventListener("input", ()=>{ g.unitPrice=num(iPU.value,0); g.unitAuto=false; refreshComputed(); });
    tdPU.appendChild(iPU); tr.appendChild(tdPU);

    const tdCost = document.createElement("td"); tdCost.className="right col-cost";
    const iCost = makeInput(g.costPerDay,"number"); iCost.step="1"; iCost.min="0";
    iCost.addEventListener("input", ()=>{ g.costPerDay=num(iCost.value,0); g.costAuto=false; refreshComputed(); });
    tdCost.appendChild(iCost); tr.appendChild(tdCost);

    const tdTot = document.createElement("td"); tdTot.className="right col-total line-total";
    tdTot.textContent = €(gearLineTotal(g));
    tr.appendChild(tdTot);

    const tdAct = document.createElement("td"); tdAct.className="center col-actions";
    tdAct.appendChild(iconBtn("Suppr.","danger",()=>{ state.gear.splice(idx,1); renderTables(); refreshComputed(); }));
    tr.appendChild(tdAct);

    els.gearBody.appendChild(tr);
  });

  refreshComputed();
}

function refreshComputed(){
  syncControls();

  // update auto gear cost (if amort/fallback changed)
  state.gear.forEach(g => {
    if (g.costAuto){
      const it = INVENTORY[g.invIndex];
      g.costPerDay = gearCostPerDay(it);
    }
  });

  // update service rows PU readOnly + totals
  [...els.servicesBody.querySelectorAll("tr")].forEach(tr => {
    const idx = Number(tr.dataset.index);
    const line = state.services[idx];
    const puInput = tr.children[4].querySelector("input");
    const totCell = tr.querySelector(".line-total");

    const derived = (state.pricing.mode==="margin" && num(line.costUnit,0)>0);
    puInput.readOnly = derived;
    puInput.value = derived ? serviceUnitPrice(line).toFixed(2) : num(line.unitPrice,0);

    totCell.textContent = €(serviceLineTotal(line));
  });

  // update gear totals
  [...els.gearBody.querySelectorAll("tr")].forEach(tr => {
    const idx = Number(tr.dataset.index);
    const g = state.gear[idx];
    const costInput = tr.children[4].querySelector("input");
    if (g.costAuto) costInput.value = num(g.costPerDay,0);
    tr.querySelector(".line-total").textContent = €(gearLineTotal(g));
  });

  renderTotals();
}

function renderTotals(){
  const htServices = state.services.reduce((s,l)=>s+serviceLineTotal(l),0);
  const htGear = state.gear.reduce((s,g)=>s+gearLineTotal(g),0);
  const ht = htServices + htGear;

  const costServices = state.services.reduce((s,l)=>s+serviceLineCost(l),0);
  const costGear = state.gear.reduce((s,g)=>s+gearLineCost(g),0);
  const cost = costServices + costGear;

  const profit = ht - cost;
  const profitShare = ht > 0 ? profit / ht : 0;

  const vat = ht * state.pricing.vatRate;
  const ttc = ht + vat;

  const target = state.pricing.targetMargin;
  const cls = profitShare >= target ? "ok" : (profitShare >= target*0.8 ? "mid" : "no");
  const cls2 = ht>0 ? cls : "mid";

  els.totalsBlock.innerHTML = `
    <div class="kpi">
      <div class="lab">Total HT</div>
      <div class="val">${€(ht)}</div>
      <div class="hint">Services: ${€(htServices)} · Matériel: ${€(htGear)}</div>
    </div>
    <div class="kpi">
      <div class="lab">TVA (${Math.round(state.pricing.vatRate*100)}%)</div>
      <div class="val">${€(vat)}</div>
      <div class="hint">Total TTC: <b>${€(ttc)}</b></div>
    </div>
    <div class="kpi">
      <div class="lab">Marge / bénéfice estimé</div>
      <div class="val ${cls2}">${€(profit)}</div>
      <div class="hint ${cls2}">
        ${Math.round(profitShare*100)}% du HT · objectif ${Math.round(target*100)}%
      </div>
    </div>
  `;
}

/* ===== Actions ===== */
function loadPack(append=false){
  syncControls();
  const type = els.packType.value;
  const level = els.packLevel.value;
  if (!PACKS[type] || !PACKS[type][level]){
    alert("Pack introuvable.");
    return;
  }
  PACKS[type][level](append);

  // prefill PU if desired (only meaningful in manual mode or cost=0)
  if (state.prefs.prefillPU){
    state.services.forEach(l => {
      if (state.pricing.mode==="manual" && num(l.unitPrice,0)===0 && num(l.costUnit,0)>0){
        l.unitPrice = suggestedPU(num(l.costUnit,0));
      }
    });
  }
  renderTables();
}
els.btnLoadPack.addEventListener("click", () => loadPack(false));
els.btnAppendPack.addEventListener("click", () => loadPack(true));
els.btnReset.addEventListener("click", () => { state.services=[]; state.gear=[]; renderTables(); });

els.btnAddService.addEventListener("click", () => {
  addServiceLine({name:"Nouvelle prestation", desc:"", unit:"jour", qty:1, costUnit:0, unitPrice:0});
  renderTables();
});
els.btnAddGear.addEventListener("click", () => { addGearLine({invIndex:0, qty:1, days:1}); renderTables(); });

els.btnPrint.addEventListener("click", () => window.print());

els.btnExportJson.addEventListener("click", () => {
  const payload = {
    ...state,
    meta: {
      quoteNumber: els.quoteNumber.value.trim(),
      quoteDate: els.quoteDate.value,
      issuerName: els.issuerName.value.trim(),
      vatRegime: els.vatRegime.value.trim(),
      clientName: els.clientName.value.trim(),
      clientContact: els.clientContact.value.trim(),
      projectName: els.projectName.value.trim(),
      projectPlace: els.projectPlace.value.trim(),
      notes: els.notes.value.trim()
    }
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (payload.meta.quoteNumber || "devis_mcp") + ".json";
  a.click();
  URL.revokeObjectURL(a.href);
});

els.btnImportJson.addEventListener("click", () => els.jsonFile.click());
els.jsonFile.addEventListener("change", async () => {
  const f = els.jsonFile.files[0];
  if (!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    Object.assign(state.pricing, obj.pricing || {});
    Object.assign(state.gearCost, obj.gearCost || {});
    Object.assign(state.prefs, obj.prefs || {});
    state.services = Array.isArray(obj.services) ? obj.services : [];
    state.gear = Array.isArray(obj.gear) ? obj.gear : [];

    const m = obj.meta || {};
    els.quoteNumber.value = m.quoteNumber || "";
    els.quoteDate.value = m.quoteDate || "";
    els.issuerName.value = m.issuerName || "Momentum Creative Productions (MCP)";
    els.vatRegime.value = m.vatRegime || "Assujetti TVA — Régime simplifié";
    els.clientName.value = m.clientName || "";
    els.clientContact.value = m.clientContact || "";
    els.projectName.value = m.projectName || "";
    els.projectPlace.value = m.projectPlace || "";
    els.notes.value = m.notes || "";

    els.pricingMode.value = state.pricing.mode || "margin";
    els.targetMargin.value = state.pricing.targetMargin ?? 0.5;
    els.vatRate.value = state.pricing.vatRate ?? 0.2;
    els.amortDays.value = state.gearCost.amortDays ?? 120;
    els.fallbackGearCostShare.value = state.gearCost.fallbackShare ?? 0.4;
    els.prefillPU.value = state.prefs.prefillPU ? "yes" : "no";

    renderTables();
  }catch(e){
    alert("JSON invalide.");
  }finally{
    els.jsonFile.value = "";
  }
});

// Recalc when global settings change
[els.pricingMode, els.targetMargin, els.vatRate, els.amortDays, els.fallbackGearCostShare, els.prefillPU]
  .forEach(el => el.addEventListener("input", () => { refreshComputed(); }));

/* ===== init ===== */
(function init(){
  const d = new Date();
  const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  els.quoteDate.value = iso;
  els.quoteNumber.value = "MCP-" + d.getFullYear() + "-001";
  renderTables();
})();
</script>
</body>
</html>
